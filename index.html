<!DOCTYPE html>
<html lang="fr">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NTCJTDPSJL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag("js", new Date());
  gtag("config", "G-NTCJTDPSJL");
</script>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<meta name="description" content="Planifiez voyages, vacances et √©v√©nements en toute s√©r√©nit√©. M√©t√©o bas√©e sur 10 ans de donn√©es historiques et mod√®les ECMWF. 22 destinations, pr√©visions jusqu'√† 1 an."/>
<title>BestDateWeather ‚Äî La m√©t√©o de vos grandes occasions</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=DM+Sans:wght@300;400;500;600;700&family=Fraunces:ital,wght@0,900;1,900&display=swap"/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=DM+Sans:wght@300;400;500;600;700&family=Fraunces:ital,wght@0,900;1,900&display=swap" rel="stylesheet" media="print" onload="this.media='all'"/>
<noscript><link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;900&family=DM+Sans:wght@300;400;500;600;700&family=Fraunces:ital,wght@0,900;1,900&display=swap" rel="stylesheet"/></noscript>
<style>
:root{
  --cream:#faf8f3;--cream2:#f2ede2;--navy:#1a1f2e;--navy2:#252d42;
  --gold:#e8940a;--gold2:#f5b020;--gold-light:#fef3d0;
  --slate:#4a5568;--slate2:#5c687a;--slate3:#6b7a8d;
  --green:#1a7a4a;--green-bg:#e8f8f0;
  --blue:#1a5f9a;--blue-bg:#e8f2fc;
  --mist:#7a8fa8;--mist-bg:#eef3f8;
  --shadow:0 4px 24px rgba(26,31,46,.08);--shadow-lg:0 12px 48px rgba(26,31,46,.14);
  --r:18px;--r-sm:12px;--r-xs:8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--navy);min-height:100vh;-webkit-font-smoothing:antialiased}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header.app-header{max-width:620px;margin:0 auto;padding:40px 20px 0;text-align:center}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(.85)}}
.app-title{font-family:'Fraunces',serif;font-size:clamp(28px,5vw,44px);font-weight:900;color:var(--navy);line-height:1.1;letter-spacing:-.5px;margin-bottom:10px}
.app-title em{font-style:italic;color:var(--gold);font-weight:900}
.app-sub{font-size:14px;color:var(--slate2);font-weight:400;line-height:1.7;max-width:440px;margin:0 auto 32px}

/* ‚îÄ‚îÄ SEARCH CARD ‚îÄ‚îÄ */
.wrap{max-width:620px;margin:0 auto;padding:0 20px 80px}
.search-card{background:white;border-radius:var(--r);box-shadow:var(--shadow-lg);padding:28px;border:1px solid rgba(26,31,46,.05);margin-bottom:20px}

.field-group{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px}
@media(max-width:500px){.field-group{grid-template-columns:1fr}}

.field-wrap{position:relative}
.field-label{font-size:11px;font-weight:700;color:var(--slate2);letter-spacing:.6px;text-transform:uppercase;margin-bottom:7px;display:flex;align-items:center;gap:6px}
.field-label svg{opacity:.6}
.inp{width:100%;background:white;border:2px solid var(--cream2);border-radius:var(--r-sm);color:var(--navy);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;padding:13px 40px 13px 16px;outline:none;transition:border-color .2s}
.inp::placeholder{color:var(--slate3);font-weight:400}
.inp:focus{outline:3px solid rgba(232,148,10,.35);outline-offset:0;background:white;border-color:var(--gold)}
.inp[type=date]{color:var(--navy)}
.inp[type=date]::-webkit-datetime-edit-fields-wrapper{opacity:1}
.inp[type=date]::-webkit-calendar-picker-indicator{opacity:0.6;cursor:pointer}

.date-hint{font-size:11px;color:var(--slate2);font-weight:500;margin-top:5px;padding-left:2px}

/* Autocomplete */
.inp-wrap{position:relative}
.inp-clear{position:absolute;right:12px;top:50%;transform:translateY(-50%);width:20px;height:20px;border:none;background:var(--cream2);border-radius:50%;cursor:pointer;display:none;align-items:center;justify-content:center;color:var(--slate2);font-size:14px;line-height:1;padding:0;transition:all .15s}
.inp-clear:hover{background:var(--slate3);color:white}
.inp-clear.visible{display:flex}
.field-wrap .inp{padding-right:40px}
.ac-list{position:absolute;top:calc(100% + 6px);left:0;right:0;background:white;border-radius:var(--r-sm);box-shadow:var(--shadow-lg);border:1px solid var(--cream2);z-index:100;display:none;max-height:220px;overflow-y:auto}
.ac-item{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer;font-size:13px;font-weight:500;color:var(--navy);border-bottom:1px solid var(--cream)}
.ac-item:last-child{border-bottom:none}
.ac-item:hover,.ac-item.sel{background:var(--gold-light);color:var(--navy)}
.ac-sub{font-size:11px;color:var(--slate3);font-weight:400}

/* Use case pills */
.uc-row{display:flex;gap:6px;flex-wrap:nowrap;margin-bottom:0;overflow-x:auto}
.uc-filter-wrap{padding:16px 0 4px;}
.uc-filter-label{font-size:10px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;color:var(--slate3);margin-bottom:10px}
.uc-pills-row{display:flex;flex-wrap:wrap;gap:6px;}
.uc-pill{display:inline-flex;align-items:center;gap:4px;padding:5px 9px;background:var(--cream);border:1.5px solid var(--cream2);border-radius:20px;font-size:11px;font-weight:600;color:var(--slate);cursor:pointer;transition:all .18s;white-space:nowrap}
.uc-pill:hover{border-color:var(--gold);background:var(--gold-light);color:var(--navy)}
#date-form.uc-required{opacity:.45;pointer-events:none;user-select:none}
#date-form.uc-required::after{content:"";position:absolute;inset:0;cursor:not-allowed}
#date-form{position:relative;transition:opacity .2s}
.uc-hint{font-size:11px;color:var(--gold);font-weight:600;text-align:center;margin-bottom:8px;display:none}
.uc-hint.visible{display:block}
#annual-wrap .annual-city-row{position:relative}
#annual-wrap.uc-required-ann .search-card{opacity:.45;pointer-events:none}
.uc-pill.active{border-color:var(--gold);background:var(--gold-light);color:var(--navy);font-weight:700}
.uc-pill-neutral{}
.uc-label-unused{font-size:10px;font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:7px}

/* CTA button */
.btn-go{width:100%;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;border-radius:var(--r-sm);color:white;font-family:'DM Sans',sans-serif;font-weight:700;font-size:15px;padding:16px;cursor:pointer;transition:all .2s;letter-spacing:.2px;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 16px rgba(232,148,10,.3);margin-bottom:20px}
.btn-go:hover:not(:disabled){filter:brightness(1.06);transform:translateY(-1px);box-shadow:0 8px 24px rgba(232,148,10,.35)}
.btn-go:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
.btn-go svg{width:18px;height:18px;opacity:.8}

/* Progress */
.prog-wrap{margin-top:14px;display:none}
.prog-labels{display:flex;justify-content:space-between;flex-shrink:0;font-size:11px;color:var(--slate2);margin-bottom:6px;font-weight:600}
.prog-track{height:4px;background:var(--cream2);border-radius:2px;overflow:hidden}
.prog-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--gold),var(--gold2));border-radius:2px;transition:width .3s}
.err-box{background:#fff5f5;border:2px solid #fca5a5;border-radius:var(--r-sm);padding:12px 16px;font-size:13px;color:#dc2626;margin-top:12px;display:none;font-weight:500}

/* ‚îÄ‚îÄ HERO RESULT ‚îÄ‚îÄ */
.hero{background:white;border-radius:var(--r);box-shadow:var(--shadow-lg);overflow:hidden;margin-bottom:16px;display:none;border:1px solid var(--cream2);border-top:3px solid var(--gold);max-width:580px;margin-left:auto;margin-right:auto}
.hero-top{background:white;padding:28px 28px 24px;color:var(--navy);position:relative;overflow:hidden;border-bottom:1px solid var(--cream2)}
.hero-top::after{display:none}

.hero-meta{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px}
.hero-loc-wrap{}
.hero-loc{font-size:15px;font-weight:700;color:var(--navy);margin-bottom:3px;letter-spacing:.1px}
.hero-date{font-size:12px;color:var(--slate3);font-weight:400}
.confidence-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:.4px;flex-shrink:0}
.conf-real{background:var(--green-bg);color:var(--green);border:1px solid rgba(26,122,74,.2)}
.conf-hybrid{background:var(--blue-bg);color:var(--blue);border:1px solid rgba(26,95,154,.2)}
.conf-profile{background:var(--mist-bg);color:var(--mist);border:1px solid rgba(122,143,168,.25)}
.conf-dot{width:6px;height:6px;border-radius:50%;background:currentColor}

.hero-main{display:flex;align-items:flex-end;justify-content:space-between;gap:16px}
.hero-temp-wrap{}
.hero-temp{font-family:'Playfair Display',serif;font-size:82px;font-weight:900;line-height:.9;letter-spacing:-4px}
.hero-temp sup{font-size:32px;vertical-align:super;letter-spacing:0;font-weight:600}
.hero-cond{font-size:17px;font-weight:600;color:var(--slate);margin-top:8px;letter-spacing:.2px}
.hero-range{font-size:12px;color:var(--slate3);margin-top:3px;font-weight:400}
.hero-horizon-label{display:inline-block;font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;padding:3px 10px;border-radius:10px;margin-top:6px}
.hl-real{background:var(--green-bg);color:var(--green)}
.hl-tendency{background:var(--blue-bg);color:var(--blue)}
.hl-profile{background:var(--mist-bg);color:var(--mist)}
.hero-icon svg{width:96px;height:96px;flex-shrink:0}

.hero-stats{display:flex;gap:0;padding:18px 28px;border-top:1px solid var(--cream2);background:white}
.hstat{flex:1;padding:0 16px;border-right:1px solid var(--cream2);text-align:center}
.hstat:first-child{padding-left:0;text-align:left}
.hstat:last-child{border-right:none;padding-right:0;text-align:right}
.hstat-val{font-size:20px;font-weight:700;color:var(--navy);margin-bottom:2px;font-family:'Playfair Display',serif}
.hstat-lbl{font-size:10px;font-weight:600;color:var(--slate3);text-transform:uppercase;letter-spacing:.5px}

/* Astro row */
.hero-astro{display:flex;gap:20px;padding:14px 28px 18px;background:white;border-top:1px solid var(--cream2);flex-wrap:wrap}
.astro-item{display:flex;align-items:center;gap:8px}
.astro-ico{display:flex;align-items:center}
.astro-val{font-size:13px;font-weight:600;color:var(--navy);line-height:1.3}
.astro-lbl{font-size:10px;color:var(--slate3);font-weight:500;text-transform:uppercase;letter-spacing:.4px}

/* ‚îÄ‚îÄ HOURLY ‚îÄ‚îÄ */
.sec-block{display:none;margin-bottom:16px;max-width:580px;margin-left:auto;margin-right:auto}
.sec-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.sec-title{font-size:11px;font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:.8px}
.sec-hint{font-size:11px;color:var(--slate3);font-weight:400}

.hourly-card{background:white;border-radius:var(--r);padding:16px 10px 14px;box-shadow:var(--shadow);border:1px solid rgba(26,31,46,.04)}
.h-strip{display:flex;width:100%}
.h-cell{flex:1 1 0;min-width:0;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 2px 10px;border-radius:var(--r-xs);transition:background .15s}
.h-cell:hover{background:var(--cream)}
.h-hr{font-size:9px;font-weight:700;color:var(--slate3);letter-spacing:.3px}
.h-ic svg{width:26px;height:26px}
.h-tp{font-size:12px;font-weight:700;color:var(--navy)}
.h-lb{font-size:8px;font-weight:600;color:var(--slate2);text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%}
.h-rb{width:88%;height:3px;background:var(--cream2);border-radius:2px;overflow:hidden;margin-top:1px}
.h-rf{height:100%;background:linear-gradient(90deg,#90c8f8,#4a9fd4);border-radius:2px}

/* ‚îÄ‚îÄ SCENARIOS ‚îÄ‚îÄ */
.sc-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:520px){.sc-row{grid-template-columns:1fr}}
.sc-card{background:white;border-radius:var(--r);padding:20px 18px;box-shadow:var(--shadow);border:1px solid rgba(26,31,46,.04)}
.sc-card.pess{border-top:3px solid #90c8f8}
.sc-card.opt{border-top:3px solid var(--gold2)}
.sc-head{display:flex;align-items:flex-start;gap:10px;margin-bottom:14px}
.sc-label{display:inline-block;font-size:9px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;padding:3px 8px;border-radius:10px;margin-bottom:4px}
.sc-label.pess{background:var(--blue-bg);color:var(--blue)}
.sc-label.opt{background:var(--gold-light);color:var(--gold)}
.sc-ttl{font-size:13px;font-weight:700;color:var(--navy)}
.sc-sub{font-size:11px;color:var(--slate2);margin-top:1px}
.sc-strip{display:flex;width:100%;margin-bottom:12px}
.sc-cell{flex:1 1 0;display:flex;flex-direction:column;align-items:center;gap:3px;padding:3px 1px}
.sc-cell svg{width:20px;height:20px}
.sc-hr{font-size:8px;color:var(--slate3);font-weight:600}
.sc-tp{font-size:9px;font-weight:700;color:var(--navy)}
.sc-stats{display:flex;gap:12px;padding-top:10px;border-top:1px solid var(--cream2);flex-wrap:wrap}
.sc-stat-val{font-size:14px;font-weight:700;color:var(--navy);font-family:'Playfair Display',serif}
.sc-stat-lbl{font-size:10px;color:var(--slate3);font-weight:500}

/* ‚îÄ‚îÄ NOTE / ATTRIBUTION ‚îÄ‚îÄ */
.note{text-align:center;font-size:11px;color:var(--slate3);line-height:1.9;padding:6px 16px 0;font-weight:400;max-width:580px;margin-left:auto;margin-right:auto}
.note strong{color:var(--slate2);font-weight:600}
.attr-link{display:inline-flex;align-items:center;justify-content:center;gap:8px;margin-top:16px;font-size:11px;color:var(--slate3);font-weight:600;text-decoration:none;padding:9px 18px;border:1.5px solid var(--cream2);border-radius:20px;transition:all .18s;background:white}
.attr-link:hover{border-color:var(--gold);color:var(--navy);background:var(--gold-light)}

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty{padding:0 20px 12px;max-width:580px;margin-left:auto;margin-right:auto}

.empty-intro em{font-style:normal;color:var(--navy)}




.uc-icon{font-size:26px;line-height:1;flex-shrink:0;margin-top:1px}
.uc-name{font-size:13px;font-weight:700;color:var(--navy);margin-bottom:3px}
.uc-desc{font-size:11px;color:var(--slate2);line-height:1.5;font-weight:400}
.uc-example{font-size:11px;color:var(--gold);font-weight:600;margin-top:6px}

/* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
@media(max-width:768px){.desktop-only{display:none}}
.app-footer{text-align:center;padding:20px 20px 40px;font-size:11px;color:var(--slate2)}

/* ‚îÄ‚îÄ MODE TOGGLE ‚îÄ‚îÄ */
.mode-toggle{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:22px}
.mode-btn{padding:14px 16px;border:2px solid var(--cream2);border-radius:var(--r-sm);background:white;font-family:"DM Sans",sans-serif;color:var(--slate2);cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px;text-align:left;box-shadow:var(--shadow)}
.mode-btn:hover:not(.active){border-color:var(--slate3);color:var(--navy);transform:translateY(-1px)}
.mode-btn.active{background:var(--gold-light);color:var(--navy);border-color:var(--gold);box-shadow:0 4px 16px rgba(232,148,10,.15)}
.mode-btn svg{width:20px;height:20px;flex-shrink:0;opacity:.7}
.mode-btn.active svg{opacity:1}
.mode-btn-title{font-size:13px;font-weight:700;line-height:1.2;display:block}
.mode-btn-sub{font-size:10px;font-weight:500;opacity:.8;line-height:1.3;display:block;margin-top:2px}


/* ‚îÄ‚îÄ SCORE M√âT√âO ‚îÄ‚îÄ */
.score-block{padding:20px 28px 18px;background:white;border-bottom:1px solid var(--cream2)}
.score-row{display:flex;align-items:center;gap:20px}
.score-ring-wrap{position:relative;flex-shrink:0;width:72px;height:72px}
.score-ring-wrap svg{transform:rotate(-90deg)}
.score-ring-bg{fill:none;stroke:var(--cream2);stroke-width:6}
.score-ring-fill{fill:none;stroke-width:6;stroke-linecap:round;transition:stroke-dashoffset .8s cubic-bezier(.4,0,.2,1),stroke .4s}
.score-num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--navy)}
.score-info{flex:1;min-width:0}
.score-usecase{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--slate3);margin-bottom:4px}
.score-verdict{font-size:15px;font-weight:700;color:var(--navy);margin-bottom:3px}
.score-risk{font-size:12px;color:var(--slate2);line-height:1.5}
.score-chips{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.score-chip{display:flex;align-items:center;gap:6px;padding:7px 12px;background:var(--cream);border-radius:20px;border:1.5px solid var(--cream2)}
.score-chip-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.score-chip-lbl{font-size:11px;font-weight:600;color:var(--slate)}
.score-chip-val{font-size:12px;font-weight:700;color:var(--navy)}


/* ‚îÄ‚îÄ TOOLTIP SCORE ‚îÄ‚îÄ */
.score-info-btn{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:var(--cream2);color:var(--slate3);font-size:10px;font-weight:700;cursor:pointer;border:none;margin-left:6px;vertical-align:middle;transition:all .15s;flex-shrink:0}
.score-info-btn:hover{background:var(--navy);color:white}
.score-tooltip{display:none;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);width:220px;min-width:200px;background:var(--navy);color:white;border-radius:10px;padding:12px 14px;font-size:11px;line-height:1.8;z-index:1000;box-shadow:0 8px 24px rgba(26,31,46,.35)}
.score-tooltip::after{display:none}
.score-info-wrap{position:relative;display:inline-block;z-index:1000}
.score-tooltip.visible{display:block}

/* ‚îÄ‚îÄ BADGE RECOMMAND√â (vue annuelle) ‚îÄ‚îÄ */
.month-card.recommended{border-color:var(--gold) !important;box-shadow:0 4px 16px rgba(232,148,10,.2)}
.month-card.recommended::before{background:var(--gold) !important}
.month-badge-rec{position:absolute;top:8px;left:8px;background:var(--gold);color:white;font-size:9px;font-weight:700;letter-spacing:.4px;text-transform:uppercase;padding:2px 7px;border-radius:8px;display:none}
.month-card.recommended .month-badge-rec{display:block}

/* ‚îÄ‚îÄ ANNUAL VIEW ‚îÄ‚îÄ */
.annual-wrap{display:none}
.annual-city-row{display:flex;gap:10px;align-items:flex-end;margin-bottom:0}
.annual-city-row .field-wrap{flex:1}
.annual-btn{background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;border-radius:var(--r-sm);color:white;font-family:'DM Sans',sans-serif;font-weight:700;font-size:14px;padding:13px 20px;cursor:pointer;transition:all .2s;white-space:nowrap}
.annual-btn:hover:not(:disabled){background:var(--navy2);transform:translateY(-1px)}
.annual-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}

.annual-result{display:none;margin-top:20px}
.annual-header{margin-bottom:16px}
.annual-city-name{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--navy)}
.annual-subtitle{font-size:12px;color:var(--slate2);margin-top:3px}

.months-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
@media(max-width:600px){.months-grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:400px){.months-grid{grid-template-columns:repeat(2,1fr)}}

.month-card{background:white;border-radius:var(--r-sm);padding:14px 12px 44px;box-shadow:var(--shadow);border:1.5px solid var(--cream2);cursor:default;transition:all .18s;position:relative;overflow:hidden}
.month-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--month-color,var(--cream2))}
.month-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(26,31,46,.1)}
.month-name{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--slate2);margin-bottom:6px;height:18px;overflow:hidden;margin-top:18px}
.month-icon{margin-bottom:10px;line-height:1;margin-top:6px;height:36px;display:flex;align-items:center}
.month-icon svg{width:32px;height:32px}
.month-temp{font-family:'Playfair Display',serif;font-size:18px;font-weight:700;color:var(--navy);margin-bottom:4px;height:26px}
.month-range{font-size:10px;color:var(--slate3);font-weight:500;margin-bottom:10px;height:16px}
.month-stats{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:4px;min-height:36px;align-content:flex-start}
.month-stat{font-size:10px;color:var(--slate2);font-weight:500;display:flex;align-items:center;gap:3px}
.month-bar{position:absolute;bottom:26px;left:12px;right:12px;height:3px;background:var(--cream2);border-radius:2px;overflow:hidden}
.month-bar-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,#90c8f8,#4a9fd4)}

/* score badge */
.month-score{position:absolute;top:10px;right:10px;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700}
.month-seas-badge{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:8px;font-weight:700;letter-spacing:.4px;background:#dbeafe;color:#1e40af;padding:2px 6px;border-radius:4px;text-transform:uppercase;white-space:nowrap}
.month-badge{display:none;position:absolute;top:-1px;left:50%;transform:translateX(-50%);font-size:9px;font-weight:800;letter-spacing:.4px;text-transform:uppercase;padding:3px 9px;border-radius:0 0 8px 8px;white-space:nowrap}
.month-badge.rec{display:block;background:#1a7a4a;color:white}
.month-badge.avoid{display:block;background:#f59e0b;color:white}
.month-card.is-rec{border-color:#1a7a4a;border-top:3px solid #1a7a4a!important;box-shadow:0 4px 20px rgba(26,122,74,.15)}
.month-card.is-avoid{border-color:#ef4444;border-top:3px solid #ef4444!important}
.annual-subtitle-uc{font-size:11px;font-weight:700;color:var(--gold);margin-top:4px;display:none}
.month-best-badge{display:block;text-align:center;background:linear-gradient(135deg,#e8940a,#f5b94a);color:white;font-size:9px;font-weight:800;padding:3px 8px;border-radius:8px;white-space:nowrap;letter-spacing:.3px;margin:6px 0 2px}
.score-5{background:#d1fae5;color:#065f46}
.score-4{background:#fef3c7;color:#92400e}
.score-3{background:#fee2e2;color:#991b1b}

/* Animations */
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.hero,.sec-block,.annual-result{animation:fadeUp .35s ease both}
@keyframes monthIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.month-card{animation:monthIn .3s ease both}

/* SEO HUB toggle mobile */
.seo-hub-toggle{display:none;width:100%;background:#f0ebe0;border:1.5px solid #e8e0d0;border-radius:12px;padding:14px 18px;font-size:14px;font-weight:700;color:#1a1f2e;text-align:left;cursor:pointer;align-items:center;justify-content:space-between}
.seo-hub-toggle-icon{font-size:18px;transition:transform .3s;display:inline-block}
.seo-hub-toggle.open .seo-hub-toggle-icon{transform:rotate(180deg)}
@media(max-width:640px){
  .seo-hub-toggle{display:flex}
  #seo-hub{display:none!important;padding:28px 16px 36px}
  #seo-hub.open{display:block!important}
}

#inp-date:not(.has-val){color:var(--slate3)}
#inp-date.has-val{color:var(--navy)}
</style>
<link rel="icon" type="image/x-icon" href="favicon.ico"/><link rel="icon" type="image/svg+xml" href="favicon.svg"/><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"/><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"/><meta name="theme-color" content="#1a1f2e"/>
<link rel="manifest" href="manifest.json"/>
<link rel="preconnect" href="https://cdnjs.cloudflare.com"/>
<link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css"></noscript>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/l10n/fr.js"></script>
</head>
<body>

<header class="app-header">
  <h1 class="app-title">Best<em>Date</em>Weather</h1>
  <div style="text-align:center;margin-bottom:8px;font-size:11px"><span style="color:var(--slate2);padding:3px 8px;border-radius:10px;border:1px solid var(--cream2);font-weight:700">FR</span> <a href="en/app.html" style="color:var(--slate2);text-decoration:none;padding:3px 8px;border-radius:10px;border:1px solid var(--cream2)">EN</a></div>
<p class="app-sub">Choisissez la meilleure date pour votre voyage, mariage ou √©v√©nement ‚Äî bas√©e sur 10&nbsp;ans de donn√©es m√©t√©o historiques et mod√®les ECMWF.</p>
</header>

<main>
<div class="wrap">
<div class="mode-toggle">
    <button class="mode-btn active" id="mode-date" onclick="switchMode('date')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      <span><span class="mode-btn-title">Date pr√©cise</span><span class="mode-btn-sub">Mariage, voyage, √©v√©nement</span></span>
    </button>
    <button class="mode-btn" id="mode-annual" onclick="switchMode('annual')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <span><span class="mode-btn-title">Vue 12 mois</span><span class="mode-btn-sub">Comparer les saisons</span></span>
    </button>
  </div>

  <!-- ANNUAL VIEW -->
  <div class="annual-wrap" id="annual-wrap">
    <div class="search-card">
      <div class="annual-city-row">
        <div class="field-wrap" style="flex:1">
          <label class="field-label" for="ann-city">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
            Destination
          </label>
          <div class="inp-wrap"><input class="inp" type="text" id="ann-city" placeholder="Paris, Lisbonne, Tokyo, Bali‚Ä¶" autocomplete="off"/>
          <button class="inp-clear" id="ann-city-clear" tabindex="-1" onclick="clearAnnCity()">√ó</button></div>
          <div class="ac-list" id="ann-ac-list"></div>
        </div>
        <button class="annual-btn" id="ann-btn" onclick="runAnnual()">Voir l'ann√©e</button>
      </div>
      <div class="prog-wrap" id="ann-prog-wrap">
        <div class="prog-labels"><span id="ann-prog-lbl">Chargement‚Ä¶</span><span id="ann-prog-pct">0%</span></div>
        <div class="prog-track"><div class="prog-bar" id="ann-prog-bar"></div></div>
      </div>
      <div class="err-box" id="ann-err-box"></div>
    </div>
    <div style="padding:12px 0 4px">
      <div class="uc-filter-label" style="margin-bottom:8px">Affiner le score pour</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;">
        <button class="uc-pill uc-pill-neutral" data-uc="general" id="ann-uc-general" onclick="quickFill('general')">üå§Ô∏è Juste la m√©t√©o</button>
        <button class="uc-pill" data-uc="voyage" onclick="quickFill('voyage')">‚úàÔ∏è Voyage</button>
        <button class="uc-pill" data-uc="sport" onclick="quickFill('sport')">üèîÔ∏è Outdoor</button>
        <button class="uc-pill" data-uc="festival" onclick="quickFill('festival')">üéµ Festival</button>
        <button class="uc-pill" data-uc="travaux" onclick="quickFill('travaux')">üèóÔ∏è Travaux</button>
        <button class="uc-pill" data-uc="mariage" onclick="quickFill('mariage')">üíç Mariage</button>
      </div>
    </div>
    <div class="annual-result" id="annual-result">
      <div class="annual-header">
        <div class="annual-city-name" id="ann-city-name"></div>
        <div class="annual-subtitle" id="annual-subtitle">Profil climatique mensuel ¬∑ moyenne des 3 derni√®res ann√©es</div>
        <div class="annual-subtitle-uc" id="annual-subtitle-uc"></div>
      </div>
      <div id="ann-narrative" style="display:none;margin:14px 0 4px;background:linear-gradient(135deg,#fef9f0,#fdf4e3);border:1.5px solid #f0d98a;border-radius:12px;padding:14px 16px;font-size:13px;color:#1a1f2e;line-height:1.6"></div>
      <div class="months-grid" id="months-grid"></div>
      <div class="note" id="ann-note" style="margin-top:14px"></div>
    </div>
  </div>



  <div class="uc-hint" id="uc-hint">‚¨Ü S√©lectionnez d'abord un type de projet ci-dessus</div>
  <div id="date-form">
    <div class="field-group">
      <div class="field-wrap">
        <label class="field-label" for="inp-city">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
          Ville ou destination
        </label>
        <div class="inp-wrap"><input class="inp" type="text" id="inp-city" placeholder="Paris, Barcelone, Tokyo‚Ä¶" autocomplete="off"/>
        <button class="inp-clear" id="inp-city-clear" tabindex="-1" onclick="clearCity()">√ó</button></div>
        <div class="ac-list" id="ac-list"></div>
        <div id="city-hint" style="font-size:11px;color:var(--slate2);margin-top:5px;display:none">üí° Villes compos√©es : utilisez les tirets ‚Äî <em>Pointe-√†-Pitre</em>, <em>Saint-Denis</em></div>
      </div>
      <div class="field-wrap">
        <label class="field-label" for="inp-date">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Date du projet
        </label>
        <div style="position:relative">
          <input class="inp" type="text" id="inp-date" placeholder="jj/mm/aaaa" readonly style="position:relative;z-index:2;background:white;cursor:pointer" />
          
        </div>
        <div class="date-hint" id="date-hint">Jusqu'√† 1 an √† l'avance</div>
      </div>
    </div>

    <button class="btn-go" id="btn-go" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <span id="btn-go-text">Voir la m√©t√©o</span>
    </button>
    <div class="prog-wrap" id="prog-wrap">
      <div class="prog-labels"><span id="prog-lbl">Chargement‚Ä¶</span><span id="prog-pct">0%</span></div>
      <div class="prog-track"><div class="prog-bar" id="prog-bar"></div></div>
    </div>
    <div class="err-box" id="err-box"></div>
  </div>

  <!-- USE CASE FILTER PILLS -->
  <div class="uc-filter-wrap" id="uc-filter-wrap" style="display:none">
    <div class="uc-filter-label">Affiner le score pour</div>
    <div class="uc-row" id="uc-row">
      <div class="uc-row-line">
        <button class="uc-pill uc-pill-neutral" data-uc="general" onclick="quickFill('general')">üå§Ô∏è Juste la m√©t√©o</button>
        <button class="uc-pill" data-uc="voyage" onclick="quickFill('voyage')">‚úàÔ∏è Voyage</button>
        <button class="uc-pill" data-uc="sport" onclick="quickFill('sport')">üèîÔ∏è Outdoor</button>
        <button class="uc-pill" data-uc="festival" onclick="quickFill('festival')">üéµ Festival</button>
        <button class="uc-pill" data-uc="travaux" onclick="quickFill('travaux')">üèóÔ∏è Travaux</button>
        <button class="uc-pill" data-uc="mariage" onclick="quickFill('mariage')">üíç Mariage</button>
      </div>
    </div>
  </div>

  <!-- HERO RESULT -->
  <div class="hero" id="hero">
    <div class="hero-top">
      <div class="hero-meta">
        <div class="hero-loc-wrap">
          <div class="hero-loc" id="r-loc"></div>
          <div class="hero-date" id="r-date"></div>
          <div class="hero-horizon-label" id="r-horizon-label"></div>
        </div>

      </div>
      <div class="hero-main">
        <div class="hero-temp-wrap">
          <div class="hero-temp" id="r-temp">‚Äì<sup>¬∞</sup></div>
          <div class="hero-cond" id="r-cond"></div>
          <div class="hero-range" id="r-range"></div>
        </div>
        <div class="hero-icon" id="r-icon"></div>
      </div>
    </div>
    <div class="score-block" id="score-block" style="display:none">
      <div class="score-row">
        <div class="score-ring-wrap">
          <svg width="72" height="72" viewBox="0 0 72 72">
            <circle class="score-ring-bg" cx="36" cy="36" r="30"/>
            <circle class="score-ring-fill" id="score-ring" cx="36" cy="36" r="30" stroke-dasharray="188.5" stroke-dashoffset="188.5"/>
          </svg>
          <div class="score-num" id="score-num">‚Äì</div>
        </div>
        <div class="score-info">
          <div style="display:flex;align-items:center;margin-bottom:4px">
          <div class="score-usecase" id="score-usecase" style="margin-bottom:0">M√©t√©o g√©n√©rale</div>
          <div class="score-info-wrap">
            <button class="score-info-btn" id="score-info-btn" onclick="toggleScoreTooltip()">?</button>
            <div class="score-tooltip" id="score-tooltip"></div>
          </div>
        </div>
          <div class="score-verdict" id="score-verdict">‚Äì</div>
          <div class="score-risk" id="score-risk"></div>
        </div>
      </div>
      <div class="score-chips" id="score-chips"></div>
    </div>
    <div class="hero-stats">
      <div class="hstat">
        <div class="hstat-val" id="r-rain">‚Äì</div>
        <div class="hstat-lbl">üíß Pluie probable</div>
      </div>
      <div class="hstat">
        <div class="hstat-val" id="r-wind">‚Äì</div>
        <div class="hstat-lbl">üí® Vent moyen</div>
      </div>
      <div class="hstat">
        <div class="hstat-val" id="r-sky">‚Äì</div>
        <div class="hstat-lbl">‚òÅÔ∏è Ciel</div>
      </div>
    </div>
    <div class="hero-astro">
      <div class="astro-item">
        <span class="astro-ico" id="astro-moon-ico"></span>
        <div>
          <div class="astro-val" id="astro-moon-name">‚Äì</div>
          <div class="astro-lbl">Phase lunaire</div>
        </div>
      </div>
      <div class="astro-item">
        <span class="astro-ico"><svg viewBox="0 0 28 28" fill="none" width="22" height="22"><circle cx="14" cy="10" r="5" fill="#f8d76a" opacity=".95"/><g stroke="#f8d76a" stroke-width="1.8" stroke-linecap="round"><line x1="14" y1="2" x2="14" y2="5"/><line x1="7" y1="4.5" x2="9" y2="6.5"/><line x1="21" y1="4.5" x2="19" y2="6.5"/><line x1="4.5" y1="10" x2="7" y2="10"/><line x1="23.5" y1="10" x2="21" y2="10"/></g><line x1="4" y1="19" x2="24" y2="19" stroke="rgba(26,31,46,.2)" stroke-width="1.5" stroke-linecap="round"/><g stroke="rgba(26,31,46,.4)" stroke-width="1.8" stroke-linecap="round"><line x1="9" y1="23" x2="11" y2="19.5"/><line x1="14" y1="24" x2="14" y2="20"/><line x1="19" y1="23" x2="17" y2="19.5"/></g></svg></span>
        <div>
          <div class="astro-val" id="astro-rise">‚Äì</div>
          <div class="astro-lbl">Lever soleil (UTC)</div>
        </div>
      </div>
      <div class="astro-item">
        <span class="astro-ico"><svg viewBox="0 0 28 28" fill="none" width="22" height="22"><circle cx="14" cy="10" r="5" fill="#f8b84a" opacity=".9"/><g stroke="#f8b84a" stroke-width="1.8" stroke-linecap="round"><line x1="14" y1="2" x2="14" y2="5"/><line x1="7" y1="4.5" x2="9" y2="6.5"/><line x1="21" y1="4.5" x2="19" y2="6.5"/><line x1="4.5" y1="10" x2="7" y2="10"/><line x1="23.5" y1="10" x2="21" y2="10"/></g><line x1="4" y1="19" x2="24" y2="19" stroke="rgba(26,31,46,.2)" stroke-width="1.5" stroke-linecap="round"/><g stroke="rgba(26,31,46,.4)" stroke-width="1.8" stroke-linecap="round"><line x1="9" y1="19.5" x2="11" y2="23"/><line x1="14" y1="20" x2="14" y2="24"/><line x1="19" y1="19.5" x2="17" y2="23"/></g></svg></span>
        <div>
          <div class="astro-val" id="astro-set">‚Äì</div>
          <div class="astro-lbl">Coucher soleil (UTC)</div>
        </div>
      </div>
    </div>
  </div>

  <!-- HOURLY -->
  <div class="sec-block" id="sec-hourly">
    <div class="sec-header">
      <div class="sec-title">Heure par heure</div>
      <div class="sec-hint">Temp√©ratures & m√©t√©o</div>
    </div>
    <div class="hourly-card"><div class="h-strip" id="h-strip"></div></div>
  </div>

  <!-- SCENARIOS -->
  <div class="sec-block" id="sec-scenarios">
    <div class="sec-header">
      <div class="sec-title">Sc√©narios extr√™mes</div>
      <div class="sec-hint">Enveloppes statistiques P10‚ÄìP90</div>
    </div>
    <div class="sc-row">
      <div class="sc-card pess">
        <div class="sc-head">
          <div>
            <span class="sc-label pess">Hypoth√®se basse</span>
            <div class="sc-ttl" id="sc-pess-ttl">Journ√©e difficile</div>
            <div class="sc-sub"><span id="sc-pess-sub">Frais ¬∑ pluie fr√©quente</span></div>
          </div>
        </div>
        <div class="sc-strip" id="sc-pess-strip"></div>
        <div class="sc-stats" id="sc-pess-stats"></div>
      </div>
      <div class="sc-card opt">
        <div class="sc-head">
          <div>
            <span class="sc-label opt">Hypoth√®se haute</span>
            <div class="sc-ttl" id="sc-opt-ttl">Belle journ√©e</div>
            <div class="sc-sub"><span id="sc-opt-sub">Chaud ¬∑ peu de pluie</span></div>
          </div>
        </div>
        <div class="sc-strip" id="sc-opt-strip"></div>
        <div class="sc-stats" id="sc-opt-stats"></div>
      </div>
    </div>
  </div>

  <!-- NOTES -->
  <div class="note" id="foot-note" style="display:none"></div>


  <!-- EMPTY STATE -->
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     BLOC SEO ‚Äî Deux silos de destinations
     Crawlable par Google ¬∑ Maillage interne complet
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<button class="seo-hub-toggle" onclick="var h=document.getElementById('seo-hub');h.classList.toggle('open');this.classList.toggle('open');" aria-expanded="false" aria-controls="seo-hub">
  üåç Voir les guides destinations (71 destinations)
  <span class="seo-hub-toggle-icon">‚åÑ</span>
</button>
<div id="seo-hub" class="desktop-only" style="background:#faf8f3;border-top:1px solid #e8e0d0;padding:52px 20px 60px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif">
  <div style="max-width:900px;margin:0 auto">

    <p style="font-size:11px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:#e8940a;margin-bottom:12px">Guides destinations</p>
    <h2 style="font-family:'Playfair Display',Georgia,serif;font-size:clamp(22px,3vw,30px);font-weight:700;color:#1a1f2e;margin-bottom:8px;letter-spacing:-.3px">Quand partir ? M&eacute;t&eacute;o mois par mois</h2>
    <p style="color:#4a5568;font-size:14px;margin-bottom:16px;line-height:1.7">Donn√©es Open-Meteo 2015‚Äì2024 ¬∑ Tableaux climatiques mensuels ¬∑ 71 destinations</p>
    <p style="max-width:720px;margin-bottom:40px;font-size:15px;line-height:1.8;color:#4a5568">Nos guides analysent temp√©ratures, pr√©cipitations, ensoleillement et saisonnalit√© pour d√©terminer objectivement les meilleurs mois selon votre projet ‚Äî voyage, mariage, festival ou √©v√©nement.</p>

    <!-- SILO 1 : MEILLEURE PERIODE - dominant -->
    <div style="margin-bottom:52px">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:18px">
        <p style="font-size:13px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;color:#1a1f2e;margin:0">&#127758; Meilleure p&eacute;riode par destination</p>
        <div style="flex:1;height:2px;background:linear-gradient(90deg,#e8940a,#e8e0d0)"></div>
      </div>
      <div style="margin-top:8px">

<h3 style="font-size:13px;font-weight:800;color:#4a5568;text-transform:uppercase;letter-spacing:.08em;margin:28px 0 14px">üá´üá∑ France</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:8px">
<a href="meilleure-periode-paris.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/40x30/fr.png" width="20" height="15" alt="FR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Paris</span><span style="font-size:10px;color:#5a6478">Quand partir</span></span></a><a href="meilleure-periode-nice.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/40x30/fr.png" width="20" height="15" alt="FR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Nice</span><span style="font-size:10px;color:#5a6478">Quand partir</span></span></a><a href="meilleure-periode-marseille.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/40x30/fr.png" width="20" height="15" alt="FR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Marseille</span><span style="font-size:10px;color:#5a6478">Quand partir</span></span></a><a href="meilleure-periode-bordeaux.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/40x30/fr.png" width="20" height="15" alt="FR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Bordeaux</span><span style="font-size:10px;color:#5a6478">Quand partir</span></span></a><a href="meilleure-periode-lyon.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/40x30/fr.png" width="20" height="15" alt="FR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Lyon</span><span style="font-size:10px;color:#5a6478">Quand partir</span></span></a><a href="meilleure-periode-provence.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/40x30/fr.png" width="20" height="15" alt="FR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Provence</span><span style="font-size:10px;color:#5a6478">Quand partir</span></span></a><a href="meilleure-periode-corse.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/40x30/fr.png" width="20" height="15" alt="FR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Corse</span><span style="font-size:10px;color:#5a6478">Quand partir</span></span></a><a href="meilleure-periode-bretagne.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/40x30/fr.png" width="20" height="15" alt="FR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Bretagne</span><span style="font-size:10px;color:#5a6478">Quand partir</span></span></a>
</div>
<h3 style="font-size:13px;font-weight:800;color:#4a5568;text-transform:uppercase;letter-spacing:.08em;margin:28px 0 14px">üåä M√©diterran√©e & Europe du Sud</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:8px">
<a href="meilleure-periode-toscane.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/it.png" width="20" height="15" alt="IT" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Toscane</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-santorin.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/gr.png" width="20" height="15" alt="GR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Santorin</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-majorque.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/es.png" width="20" height="15" alt="ES" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Majorque</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-ibiza.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/es.png" width="20" height="15" alt="ES" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Ibiza</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-crete.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/gr.png" width="20" height="15" alt="GR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Cr√®te</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-mykonos.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/gr.png" width="20" height="15" alt="GR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Mykonos</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-sicile.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/it.png" width="20" height="15" alt="IT" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Sicile</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-sardaigne.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/it.png" width="20" height="15" alt="IT" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Sardaigne</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-venise.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/it.png" width="20" height="15" alt="IT" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Venise</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-capri.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/it.png" width="20" height="15" alt="IT" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Capri</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-amalfi.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/it.png" width="20" height="15" alt="IT" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">C√¥te Amalfitaine</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-rome.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/it.png" width="20" height="15" alt="IT" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Rome</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-florence.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/it.png" width="20" height="15" alt="IT" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Florence</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-cote-azur.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/fr.png" width="20" height="15" alt="FR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">C√¥te d'Azur</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-malte.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/mt.png" width="20" height="15" alt="MT" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Malte</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-algarve.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/pt.png" width="20" height="15" alt="PT" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Algarve</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-lisbonne.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/pt.png" width="20" height="15" alt="PT" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Lisbonne</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-madere.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/pt.png" width="20" height="15" alt="PT" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Mad√®re</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-porto.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/pt.png" width="20" height="15" alt="PT" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Porto</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-barcelone.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/es.png" width="20" height="15" alt="ES" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Barcelone</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-malaga.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/es.png" width="20" height="15" alt="ES" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">M√°laga</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-valence.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/es.png" width="20" height="15" alt="ES" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Valence</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-alicante.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/es.png" width="20" height="15" alt="ES" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Alicante</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>


<a href="meilleure-periode-lanzarote.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/es.png" width="20" height="15" alt="ES" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Lanzarote</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-tenerife.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/es.png" width="20" height="15" alt="ES" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Tenerife</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-gran-canaria.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/es.png" width="20" height="15" alt="ES" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Gran Canaria</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-canaries.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/es.png" width="20" height="15" alt="ES" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Canaries</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-rhodes.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/gr.png" width="20" height="15" alt="GR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Rhodes</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-corfou.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/gr.png" width="20" height="15" alt="GR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Corfou</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-zante.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/gr.png" width="20" height="15" alt="GR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Zakynthos</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-dubrovnik.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/hr.png" width="20" height="15" alt="HR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Dubrovnik</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-split.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/hr.png" width="20" height="15" alt="HR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Split</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-monaco.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/mc.png" width="20" height="15" alt="MC" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Monaco</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
</div>
<h3 style="font-size:13px;font-weight:800;color:#4a5568;text-transform:uppercase;letter-spacing:.08em;margin:28px 0 14px">üè∞ Europe du Nord & Centrale</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:8px">
<a href="meilleure-periode-amsterdam.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/nl.png" width="20" height="15" alt="NL" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Amsterdam</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-berlin.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/de.png" width="20" height="15" alt="DE" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Berlin</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-londres.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/gb.png" width="20" height="15" alt="GB" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Londres</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-prague.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/cz.png" width="20" height="15" alt="CZ" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Prague</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-vienne.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/at.png" width="20" height="15" alt="AT" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Vienne</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-istanbul.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/tr.png" width="20" height="15" alt="TR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Istanbul</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-edimbourg.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/gb.png" width="20" height="15" alt="GB" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">√âdimbourg</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-reykjavik.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/is.png" width="20" height="15" alt="IS" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Reykjavik</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
</div>
<h3 style="font-size:13px;font-weight:800;color:#4a5568;text-transform:uppercase;letter-spacing:.08em;margin:28px 0 14px">üå¥ Afrique & Oc√©an Indien</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:8px">
<a href="meilleure-periode-marrakech.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/ma.png" width="20" height="15" alt="MA" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Marrakech</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-agadir.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/ma.png" width="20" height="15" alt="MA" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Agadir</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-ile-maurice.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/mu.png" width="20" height="15" alt="MU" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">√éle Maurice</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-zanzibar.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/tz.png" width="20" height="15" alt="TZ" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Zanzibar</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-reunion.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/fr.png" width="20" height="15" alt="FR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">La R√©union</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-maldives.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/mv.png" width="20" height="15" alt="MV" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Maldives</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-seychelles.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/sc.png" width="20" height="15" alt="SC" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Seychelles</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
</div>
<h3 style="font-size:13px;font-weight:800;color:#4a5568;text-transform:uppercase;letter-spacing:.08em;margin:28px 0 14px">üèØ Asie & Moyen-Orient</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:8px">
<a href="meilleure-periode-bali.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/id.png" width="20" height="15" alt="ID" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Bali</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-bangkok.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/th.png" width="20" height="15" alt="TH" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Bangkok</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-tokyo.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/jp.png" width="20" height="15" alt="JP" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Tokyo</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-phuket.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/th.png" width="20" height="15" alt="TH" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Phuket</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-dubai.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/ae.png" width="20" height="15" alt="AE" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Duba√Ø</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-hoi-an.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/vn.png" width="20" height="15" alt="VN" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">H√¥i An</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-siem-reap.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/kh.png" width="20" height="15" alt="KH" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Siem Reap</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-singapour.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/sg.png" width="20" height="15" alt="SG" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Singapour</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-katmandou.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/np.png" width="20" height="15" alt="NP" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Katmandou</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
</div>
<h3 style="font-size:13px;font-weight:800;color:#4a5568;text-transform:uppercase;letter-spacing:.08em;margin:28px 0 14px">üåé Am√©riques & Cara√Øbes</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:8px">
<a href="meilleure-periode-riviera-maya.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/mx.png" width="20" height="15" alt="MX" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Riviera Maya</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-cancun.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/mx.png" width="20" height="15" alt="MX" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Canc√∫n</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-rio-de-janeiro.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/br.png" width="20" height="15" alt="BR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Rio de Janeiro</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-buenos-aires.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/ar.png" width="20" height="15" alt="AR" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">Buenos Aires</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-la-havane.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/cu.png" width="20" height="15" alt="CU" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">La Havane</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
<a href="meilleure-periode-new-york.html" target="_top" style="background:white;border-radius:12px;padding:14px 12px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:10px"><img src="https://flagcdn.com/20x15/us.png" width="20" height="15" alt="US" style="vertical-align:middle;margin-right:6px;border-radius:2px"><span><span style="font-size:12px;font-weight:700;color:#1a1f2e;display:block">New York</span><span style="font-size:10px;color:#a0aec0">Quand partir</span></span></a>
</div>
</div>

    <!-- SILO 2 : CLASSEMENTS -->
    <div style="margin-top:52px;padding-top:40px;border-top:1.5px solid #e8e0d0">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:18px">
        <p style="font-size:13px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;color:#1a1f2e;margin:0">üèÜ Classements destinations m√©t√©o</p>
        <div style="flex:1;height:2px;background:linear-gradient(90deg,#e8940a,#e8e0d0)"></div>
      </div>
      <p style="color:#4a5568;font-size:14px;margin-bottom:24px;line-height:1.7">Classements objectifs bas√©s sur 10 ans de donn√©es climatiques ‚Äî trouvez la meilleure destination pour votre projet.</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px">
        <a href="classement-destinations-meteo-2026.html" target="_top" style="background:white;border-radius:12px;padding:16px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:12px">
          <span style="font-size:22px">üåç</span>
          <span><span style="font-size:13px;font-weight:700;color:#1a1f2e;display:block">Classement mondial 2026</span><span style="font-size:11px;color:#5a6478">Meilleures destinations m√©t√©o</span></span>
        </a>
        <a href="classement-destinations-europe-meteo-2026.html" target="_top" style="background:white;border-radius:12px;padding:16px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:12px">
          <span style="font-size:22px">üá™üá∫</span>
          <span><span style="font-size:13px;font-weight:700;color:#1a1f2e;display:block">Classement Europe 2026</span><span style="font-size:11px;color:#5a6478">Meilleure m√©t√©o en Europe</span></span>
        </a>
        <a href="classement-destinations-meteo-ete-2026.html" target="_top" style="background:white;border-radius:12px;padding:16px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:12px">
          <span style="font-size:22px">‚òÄÔ∏è</span>
          <span><span style="font-size:13px;font-weight:700;color:#1a1f2e;display:block">√ât√© 2026</span><span style="font-size:11px;color:#5a6478">Top destinations juin‚Äìao√ªt</span></span>
        </a>
        <a href="classement-destinations-meteo-hiver-2026.html" target="_top" style="background:white;border-radius:12px;padding:16px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:12px">
          <span style="font-size:22px">üå¥</span>
          <span><span style="font-size:13px;font-weight:700;color:#1a1f2e;display:block">Soleil d'hiver 2026</span><span style="font-size:11px;color:#5a6478">Destinations chaudes en hiver</span></span>
        </a>
        <a href="classement-destinations-meteo-mariage-2026.html" target="_top" style="background:white;border-radius:12px;padding:16px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:12px">
          <span style="font-size:22px">üíç</span>
          <span><span style="font-size:13px;font-weight:700;color:#1a1f2e;display:block">M√©t√©o mariage 2026</span><span style="font-size:11px;color:#5a6478">Meilleures conditions c√©r√©monie</span></span>
        </a>
        <a href="classement-destinations-meteo-nomades-2026.html" target="_top" style="background:white;border-radius:12px;padding:16px;text-decoration:none;border:1.5px solid #e8e0d0;display:flex;align-items:center;gap:12px">
          <span style="font-size:22px">üíª</span>
          <span><span style="font-size:13px;font-weight:700;color:#1a1f2e;display:block">Nomades digitaux 2026</span><span style="font-size:11px;color:#5a6478">Classement constance m√©t√©o</span></span>
        </a>
      </div>
    </div>
    </div>

  </div>
</div>
</main>
</main>

<div class="app-footer">
  <div style="font-weight:700;font-size:13px;color:var(--slate2);margin-bottom:6px">bestdateweather.com</div>
  <a href="https://open-meteo.com/" target="_blank" style="color:inherit;text-decoration:none">Donn√©es m√©t√©o par Open-Meteo.com</a>
  &nbsp;¬∑&nbsp; Sources ECMWF, DWD, NOAA, M√©t√©o-France &nbsp;¬∑&nbsp; CC BY 4.0
  &nbsp;¬∑&nbsp; <a href="methodologie.html" target="_blank" style="color:inherit;text-decoration:none">M√©thodologie</a>
  <div style="margin-top:8px"><a href="en/" style="color:inherit;text-decoration:none">üá¨üáß English version</a> &nbsp;¬∑&nbsp; <a href="mentions-legales.html" style="color:inherit;text-decoration:none">Mentions l√©gales</a> &nbsp;¬∑&nbsp; <a href="confidentialite.html" style="color:inherit;text-decoration:none">Confidentialit&eacute;</a> &nbsp;¬∑&nbsp; <a href="contact.html" style="color:inherit;text-decoration:none">Contact</a></div>
</div>

<script>
var IC = {
  sun:        '<svg viewBox="0 0 40 40" fill="none"><circle cx="20" cy="20" r="8" fill="#f59e0b"/><g stroke="#f59e0b" stroke-width="2.2" stroke-linecap="round"><line x1="20" y1="4" x2="20" y2="9"/><line x1="20" y1="31" x2="20" y2="36"/><line x1="4" y1="20" x2="9" y2="20"/><line x1="31" y1="20" x2="36" y2="20"/><line x1="8.7" y1="8.7" x2="12.2" y2="12.2"/><line x1="27.8" y1="27.8" x2="31.3" y2="31.3"/><line x1="31.3" y1="8.7" x2="27.8" y2="12.2"/><line x1="12.2" y1="27.8" x2="8.7" y2="31.3"/></g></svg>',
  partcloud:  '<svg viewBox="0 0 40 40" fill="none"><circle cx="15" cy="15" r="6" fill="#f59e0b" opacity=".9"/><g stroke="#f59e0b" stroke-width="1.8" stroke-linecap="round"><line x1="15" y1="5" x2="15" y2="8"/><line x1="5" y1="15" x2="8" y2="15"/><line x1="8.8" y1="8.8" x2="11" y2="11"/><line x1="21.2" y1="8.8" x2="19" y2="11"/></g><rect x="9" y="22" width="22" height="11" rx="5.5" fill="#93c5e8"/><ellipse cx="17" cy="22" rx="6" ry="5.5" fill="#a8d4f0"/><ellipse cx="23" cy="23" rx="5" ry="4.5" fill="#bde0f8"/></svg>',
  cloud:      '<svg viewBox="0 0 40 40" fill="none"><rect x="7" y="20" width="26" height="13" rx="6.5" fill="#93a8c0"/><ellipse cx="17" cy="20" rx="8" ry="7" fill="#a8bccc"/><ellipse cx="25" cy="21" rx="7" ry="6" fill="#bcd0e0"/></svg>',
  lightrain:  '<svg viewBox="0 0 40 40" fill="none"><rect x="6" y="11" width="28" height="11" rx="5.5" fill="#6a92b0"/><ellipse cx="16" cy="11" rx="8" ry="6.5" fill="#7aa2c0"/><ellipse cx="25" cy="12" rx="7" ry="5.5" fill="#8ab4d0"/><g stroke="#3b82f6" stroke-width="2.2" stroke-linecap="round"><line x1="18" y1="25" x2="16" y2="33"/></g></svg>',
  rain:       '<svg viewBox="0 0 40 40" fill="none"><rect x="6" y="11" width="28" height="11" rx="5.5" fill="#6a92b0"/><ellipse cx="16" cy="11" rx="8" ry="6.5" fill="#7aa2c0"/><ellipse cx="25" cy="12" rx="7" ry="5.5" fill="#8ab4d0"/><g stroke="#3b82f6" stroke-width="2.2" stroke-linecap="round"><line x1="13" y1="25" x2="11" y2="33"/><line x1="20" y1="25" x2="18" y2="33"/><line x1="27" y1="25" x2="25" y2="33"/></g></svg>',
  heavyrain:  '<svg viewBox="0 0 40 40" fill="none"><rect x="4" y="9" width="32" height="11" rx="5.5" fill="#5a7a98"/><ellipse cx="14" cy="9" rx="9" ry="7" fill="#6a8aa8"/><ellipse cx="27" cy="10" rx="9" ry="6.5" fill="#7a9ab8"/><g stroke="#2563eb" stroke-width="2.2" stroke-linecap="round"><line x1="10" y1="23" x2="8" y2="32"/><line x1="16" y1="23" x2="14" y2="32"/><line x1="22" y1="23" x2="20" y2="32"/><line x1="28" y1="23" x2="26" y2="32"/></g></svg>',
  storm:      '<svg viewBox="0 0 40 40" fill="none"><rect x="3" y="7" width="34" height="12" rx="6" fill="#4a6070"/><ellipse cx="13" cy="7" rx="9" ry="7" fill="#5a7080"/><ellipse cx="28" cy="8" rx="9" ry="6.5" fill="#6a8090"/><polyline points="23,19 18,28 22,28 16,38" stroke="#f59e0b" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>',
  snow:       '<svg viewBox="0 0 40 40" fill="none"><rect x="6" y="11" width="28" height="11" rx="5.5" fill="#a0c4e0"/><ellipse cx="16" cy="11" rx="8" ry="6.5" fill="#b0d4f0"/><ellipse cx="25" cy="12" rx="7" ry="5.5" fill="#c0e0f8"/><g stroke="#60a0d0" stroke-width="2" stroke-linecap="round"><line x1="12" y1="26" x2="12" y2="35"/><line x1="8.5" y1="28" x2="15.5" y2="33"/><line x1="8.5" y1="33" x2="15.5" y2="28"/><line x1="20" y1="26" x2="20" y2="35"/><line x1="16.5" y1="28" x2="23.5" y2="33"/><line x1="16.5" y1="33" x2="23.5" y2="28"/></g></svg>',
  fog:        '<svg viewBox="0 0 40 40" fill="none"><line x1="6" y1="12" x2="34" y2="12" stroke="#93a8c0" stroke-width="2.5" stroke-linecap="round" opacity=".9"/><line x1="8" y1="19" x2="32" y2="19" stroke="#7a94ac" stroke-width="2.5" stroke-linecap="round" opacity=".7"/><line x1="11" y1="26" x2="29" y2="26" stroke="#607888" stroke-width="2.5" stroke-linecap="round" opacity=".5"/></svg>',
  moon:       '<svg viewBox="0 0 40 40" fill="none"><circle cx="29" cy="8" r="1.2" fill="#f0d080" opacity=".9"/><circle cx="34" cy="17" r=".9" fill="#f0d080" opacity=".7"/><circle cx="7" cy="11" r="1" fill="#f0d080" opacity=".5"/><circle cx="19" cy="21" r="12" fill="#d4c060"/><circle cx="24" cy="18" r="10" fill="#e8f0fc"/></svg>',
  nightcloud: '<svg viewBox="0 0 40 40" fill="none"><circle cx="33" cy="7" r="1" fill="#f0d080" opacity=".8"/><circle cx="10" cy="10" r="7" fill="#d4c060"/><circle cx="13" cy="8" r="5.8" fill="#e8f0fc"/><rect x="8" y="24" width="26" height="12" rx="6" fill="#8899b4"/><ellipse cx="18" cy="24" rx="8" ry="7" fill="#99aac4"/><ellipse cx="27" cy="25" rx="7" ry="6" fill="#aabbd4"/></svg>',
  nightrain:  '<svg viewBox="0 0 40 40" fill="none"><circle cx="9" cy="9" r="6" fill="#d4c060"/><circle cx="12" cy="7" r="5" fill="#e8f0fc"/><rect x="6" y="17" width="28" height="11" rx="5.5" fill="#5a7090"/><ellipse cx="17" cy="17" rx="8" ry="6.5" fill="#6a8090"/><ellipse cx="26" cy="18" rx="7" ry="5.5" fill="#7a90a0"/><g stroke="#3b82f6" stroke-width="2.2" stroke-linecap="round"><line x1="13" y1="30" x2="11" y2="37"/><line x1="20" y1="30" x2="18" y2="37"/><line x1="27" y1="30" x2="25" y2="37"/></g></svg>',
  shower:     '<svg viewBox="0 0 40 40" fill="none"><circle cx="14" cy="12" r="5.5" fill="#f59e0b" opacity=".9"/><g stroke="#f59e0b" stroke-width="1.7" stroke-linecap="round"><line x1="14" y1="3" x2="14" y2="6"/><line x1="5" y1="12" x2="8" y2="12"/><line x1="8" y1="7" x2="10" y2="9"/><line x1="20" y1="7" x2="18" y2="9"/></g><rect x="9" y="18" width="22" height="11" rx="5.5" fill="#6a92b0"/><ellipse cx="17" cy="18" rx="6" ry="5.5" fill="#7aa2c0"/><ellipse cx="23" cy="19" rx="5" ry="4.5" fill="#8ab4d0"/><g stroke="#3b82f6" stroke-width="2.2" stroke-linecap="round"><line x1="19" y1="31" x2="17" y2="37"/></g></svg>',
  nightshower:'<svg viewBox="0 0 40 40" fill="none"><circle cx="9" cy="9" r="6" fill="#d4c060"/><circle cx="12" cy="7" r="5" fill="#e8f0fc"/><rect x="6" y="17" width="28" height="11" rx="5.5" fill="#5a7090"/><ellipse cx="17" cy="17" rx="8" ry="6.5" fill="#6a8090"/><ellipse cx="26" cy="18" rx="7" ry="5.5" fill="#7a90a0"/><g stroke="#3b82f6" stroke-width="2.2" stroke-linecap="round"><line x1="20" y1="30" x2="18" y2="36"/></g></svg>',
  nightsnow:  '<svg viewBox="0 0 40 40" fill="none"><circle cx="9" cy="9" r="6" fill="#d4c060"/><circle cx="12" cy="7" r="5" fill="#e8f0fc"/><rect x="6" y="17" width="28" height="11" rx="5.5" fill="#7090b0"/><ellipse cx="17" cy="17" rx="8" ry="6.5" fill="#80a0c0"/><ellipse cx="26" cy="18" rx="7" ry="5.5" fill="#90b0d0"/><g stroke="#60a0d0" stroke-width="2" stroke-linecap="round"><line x1="13" y1="31" x2="13" y2="38"/><line x1="10" y1="33.5" x2="16" y2="35.5"/><line x1="10" y1="35.5" x2="16" y2="33.5"/><line x1="22" y1="31" x2="22" y2="38"/><line x1="19" y1="33.5" x2="25" y2="35.5"/><line x1="19" y1="35.5" x2="25" y2="33.5"/></g></svg>'
};

/* QUICK FILL */
function quickFill(type) {
  currentUseCase = type;
  document.getElementById('score-block').style.display = 'block';
  // Unlock forms
  var df = document.getElementById('date-form');
  if (df) { df.classList.remove('uc-required'); }
  var aw = document.getElementById('annual-wrap');
  if (aw) { aw.classList.remove('uc-required-ann'); }
  var hint = document.getElementById('uc-hint');
  if (hint) { hint.style.display = 'none'; }
  var hintAnn = document.getElementById('uc-hint-ann');
  if (hintAnn) { hintAnn.style.display = 'none'; }
  var cityEl = document.getElementById('inp-city');
  var placeholders = {
    mariage:'Lieu de la r√©ception‚Ä¶', voyage:'Destination de voyage‚Ä¶',
    festival:'Lieu du festival‚Ä¶', sport:'Lieu de votre sortie‚Ä¶', travaux:'Ville du chantier‚Ä¶'
  };
  cityEl.placeholder = placeholders[type] || 'Paris, Barcelone, Tokyo‚Ä¶';
  // Re-score instantly if results already shown
  var inAnnualMode = document.getElementById('mode-annual').classList.contains('active');
  if (inAnnualMode && _lastMonthly && _lastAnnLoc) {
    renderAnnual(_lastAnnLoc, _lastMonthly);
  } else if (!inAnnualMode && _lastRows && _lastSc) {
    computeAndRenderScore(_lastSc, _lastRows);
  } else {
    if (window === window.top) { cityEl.focus(); }
    selectedLoc = null;
  }
  // Mark active pill LAST (after any recompute)
  var pills = document.querySelectorAll('.uc-pill[data-uc]');
  for (var i=0; i<pills.length; i++) {
    pills[i].classList.remove('active');
    if (pills[i].dataset.uc === type) pills[i].classList.add('active');
  }
}

function fillUseCase(type) { currentUseCase = type; document.getElementById("score-block").style.display = "block"; quickFill(type); }

function getIcon(h, temp, sol, rain, mm, snow, p25) {
  var night = sol < 15;
  mm = mm || 0;
  snow = snow || 0;
  p25 = p25 != null ? p25 : temp;
  // Snowfall direct ou nuits gel√©es (p25 ‚â§ 2¬∞C)
  var isSnowing = snow > 0.1 || (p25 != null && p25 <= 2 && mm > 0.1);
  var night = sol < 15;
  mm = mm || 0;
  if (night) {
    if (mm > 7 || (rain > 70 && mm > 2))  return IC.storm;
    if (isSnowing && rain > 15)            return IC.nightsnow;
    if (temp <= 0 && rain > 20)            return IC.nightsnow;
    if (rain > 35 && mm >= 1.5)            return IC.nightrain;
    if (rain > 20 && mm >= 0.3)            return IC.nightshower;
    if (sol < 5)                           return IC.moon;
    return IC.nightcloud;
  }
  if (mm > 7 || (rain > 70 && mm > 2))     return IC.storm;
  if (isSnowing && rain > 15)               return IC.snow;
  if (temp <= 0 && rain > 20)              return IC.snow;
  if (rain > 55 && mm >= 3)               return IC.heavyrain;
  if (rain > 35 && mm >= 1.5)             return IC.rain;
  if (rain > 20 && mm >= 0.3 && sol >= 200) return IC.shower;
  if (rain > 20 && mm >= 0.3) return IC.lightrain;
  if (rain > 35)                           return IC.rain;
  if (sol < 60 && temp < 8)              return IC.fog;
  if (sol < 130)                          return IC.cloud;
  if (sol < 420)                          return IC.partcloud;
  return IC.sun;
}

function getLabel(h, temp, sol, rain, mm, snow, p25) {
  var night = sol < 15;
  mm = mm || 0; snow = snow || 0;
  p25 = p25 != null ? p25 : temp;
  var isSnowing = snow > 0.1 || (p25 <= 2 && mm > 0.1);
  if (night) {
    if (mm > 7 || (rain > 70 && mm > 2))  return 'Orage';
    if (isSnowing && rain > 15)            return 'Neige';
    if (temp <= 0 && rain > 20)            return 'Neige';
    if (rain > 35 && mm >= 1.5)            return 'Pluie';
    if (rain > 20 && mm >= 0.3)            return 'Averses';
    if (sol < 5)                           return 'Nuit claire';
    return 'Nuit nuageuse';
  }
  if (mm > 7 || (rain > 70 && mm > 2))     return 'Orage';
  if (isSnowing && rain > 15)              return 'Neige';
  if (temp <= 0 && rain > 20)              return 'Neige';
  if (rain > 55 && mm >= 3)               return 'Fortes pluies';
  if (rain > 35 && mm >= 1.5)             return 'Pluie';
  if (rain > 20 && mm >= 0.3 && sol >= 200) return 'Averses';
  if (rain > 20 && mm >= 0.3) return 'Pluie l√©g√®re';
  if (rain > 35)                           return 'Pluie';
  if (sol < 60 && temp < 8)              return 'Brouillard';
  if (sol < 130)                          return 'Couvert';
  if (sol < 420)                          return 'Partiellement nuageux';
  return 'Ensoleill√©';
}

function pct(arr, p) {
  if (!arr || arr.length === 0) return null;
  var s = arr.slice().sort(function(a, b) { return a - b; });
  var pos = (p / 100) * (s.length - 1);
  var lo = Math.floor(pos), hi = Math.ceil(pos);
  return parseFloat((s[lo] + (s[hi] - s[lo]) * (pos - lo)).toFixed(1));
}
function cloneRow(r, overrides) {
  var out = {}, ks = Object.keys(r), os = Object.keys(overrides);
  for (var i = 0; i < ks.length; i++) out[ks[i]] = r[ks[i]];
  for (var j = 0; j < os.length; j++) out[os[j]] = overrides[os[j]];
  return out;
}
function genMain(rows) { var out = []; for (var i = 0; i < rows.length; i++) { var r = rows[i]; out.push(cloneRow(r, { temp: r.p50, sol: r.solP50 || 0 })); } return out; }

/* G√©n√©rateur pseudo-al√©atoire d√©terministe (mulberry32) */
var _seededRand = null;
function seedRand(seed) {
  var s = seed | 0;
  _seededRand = function() {
    s = Math.imul(s ^ (s >>> 15), s | 1);
    s ^= s + Math.imul(s ^ (s >>> 7), s | 61);
    return ((s ^ (s >>> 14)) >>> 0) / 4294967296;
  };
}
function seededRand() { return _seededRand ? _seededRand() : Math.random(); }
function makeSeed(lat, lon, yr, mo, da) {
  return Math.abs(Math.round(lat * 1000) * 100000 + Math.round(lon * 1000) * 100 + yr * 10000 + mo * 100 + da);
}

function genPess(rows) {
  var out = [];
  for (var i = 0; i < rows.length; i++) {
    var r = rows[i];
    out.push(cloneRow(r, { temp: r.p25 != null ? parseFloat((r.p25 - seededRand()).toFixed(1)) : r.p50, sol: Math.max(0, (r.solP25 || 0) * 0.4), rain: Math.min(100, Math.round(r.rain * 1.5 + 10)) }));
  }
  return out;
}
function genOpt(rows) {
  var out = [];
  for (var i = 0; i < rows.length; i++) {
    var r = rows[i];
    out.push(cloneRow(r, { temp: r.p75 != null ? parseFloat((r.p75 + seededRand()).toFixed(1)) : r.p50, sol: Math.min(900, (r.solP75 || 0) * 1.4), rain: Math.max(0, Math.round(r.rain * 0.35)) }));
  }
  return out;
}
function toISO(d) { var mo = d.getMonth() + 1, da = d.getDate(); return d.getFullYear() + '-' + (mo < 10 ? '0' : '') + mo + '-' + (da < 10 ? '0' : '') + da; }
function addDays(d, n) { var r = new Date(d.getTime()); r.setDate(r.getDate() + n); return r; }
function setP(p, lbl) { document.getElementById('prog-bar').style.width = p + '%'; document.getElementById('prog-pct').textContent = p + '%'; if (lbl) document.getElementById('prog-lbl').textContent = lbl; }

/* ASTRO */
function lunarPhase(year, month, day) {
  var y = year, m = month;
  if (m <= 2) { y -= 1; m += 12; }
  var A = Math.floor(y / 100), B = 2 - A + Math.floor(A / 4);
  var jd = Math.floor(365.25*(y+4716)) + Math.floor(30.6001*(m+1)) + day + B - 1524.5;
  var p = (jd - 2461057.5375) % 29.53058867;
  if (p < 0) p += 29.53058867;
  var name, svg;
  if      (p <  1.85) { name='Nouvelle lune';        svg='<svg viewBox="0 0 24 24" width="22" height="22"><circle cx="12" cy="12" r="9" fill="#c8d8f0" opacity=".25" stroke="rgba(26,31,46,.3)" stroke-width="1"/><circle cx="12" cy="12" r="9" fill="#1a2a3a" opacity=".7"/></svg>'; }
  else if (p <  7.38) { name='Croissant montant';     svg='<svg viewBox="0 0 24 24" width="22" height="22"><circle cx="12" cy="12" r="9" fill="#c8d8f0" opacity=".15"/><path d="M12 3 A9 9 0 0 1 12 21 A5 9 0 0 0 12 3 Z" fill="#f0e8a0" opacity=".9"/></svg>'; }
  else if (p <  9.22) { name='Premier quartier';      svg='<svg viewBox="0 0 24 24" width="22" height="22"><circle cx="12" cy="12" r="9" fill="#1a2a3a" opacity=".5"/><path d="M12 3 A9 9 0 0 1 12 21 Z" fill="#f0e8a0" opacity=".9"/></svg>'; }
  else if (p < 14.77) { name='Gibbeuse croissante';   svg='<svg viewBox="0 0 24 24" width="22" height="22"><circle cx="12" cy="12" r="9" fill="#f0e8a0" opacity=".9"/><path d="M12 3 A9 9 0 0 0 12 21 A3 9 0 0 1 12 3 Z" fill="#1a2a3a" opacity=".6"/></svg>'; }
  else if (p < 16.61) { name='Pleine lune';           svg='<svg viewBox="0 0 24 24" width="22" height="22"><circle cx="12" cy="12" r="9" fill="#f0e8a0" opacity=".95"/><circle cx="9" cy="10" r="1.5" fill="#d4c060" opacity=".4"/><circle cx="15" cy="14" r="1" fill="#d4c060" opacity=".3"/><circle cx="11" cy="15" r="1.2" fill="#d4c060" opacity=".35"/></svg>'; }
  else if (p < 22.15) { name='Gibbeuse d√©croissante'; svg='<svg viewBox="0 0 24 24" width="22" height="22"><circle cx="12" cy="12" r="9" fill="#f0e8a0" opacity=".9"/><path d="M12 3 A9 9 0 0 1 12 21 A3 9 0 0 0 12 3 Z" fill="#1a2a3a" opacity=".6"/></svg>'; }
  else if (p < 23.99) { name='Dernier quartier';      svg='<svg viewBox="0 0 24 24" width="22" height="22"><circle cx="12" cy="12" r="9" fill="#1a2a3a" opacity=".5"/><path d="M12 3 A9 9 0 0 0 12 21 Z" fill="#f0e8a0" opacity=".9"/></svg>'; }
  else                { name='Croissant d√©croissant'; svg='<svg viewBox="0 0 24 24" width="22" height="22"><circle cx="12" cy="12" r="9" fill="#c8d8f0" opacity=".15"/><path d="M12 3 A9 9 0 0 0 12 21 A5 9 0 0 1 12 3 Z" fill="#f0e8a0" opacity=".9"/></svg>'; }
  return { phase: p, name: name, svg: svg };
}

function sunriseSunset(lat, lon, year, month, day) {
  var N1=Math.floor(275*month/9), N2=Math.floor((month+9)/12), N3=1+Math.floor((year-4*Math.floor(year/4)+2)/3);
  var N=N1-N2*N3+day-30, lngHour=lon/15;
  function calc(sr) {
    var t=sr?N+(6-lngHour)/24:N+(18-lngHour)/24, M=0.9856*t-3.289, mR=M*Math.PI/180;
    var L=M+1.916*Math.sin(mR)+0.020*Math.sin(2*mR)+282.634; L=((L%360)+360)%360;
    var lR=L*Math.PI/180, RA=Math.atan(0.91764*Math.tan(lR))*180/Math.PI; RA=((RA%360)+360)%360;
    var Lq=Math.floor(L/90)*90, RAq=Math.floor(RA/90)*90; RA=(RA+Lq-RAq)/15;
    var sinD=0.39782*Math.sin(lR), cosD=Math.cos(Math.asin(sinD));
    var cosH=(Math.cos(90.833*Math.PI/180)-sinD*Math.sin(lat*Math.PI/180))/(cosD*Math.cos(lat*Math.PI/180));
    if (cosH>1||cosH<-1) return null;
    var H=sr?(360-Math.acos(cosH)*180/Math.PI)/15:Math.acos(cosH)*180/Math.PI/15;
    var T=H+RA-0.06571*t-6.622; return ((T-lngHour)%24+24)%24;
  }
  function fmt(h) { if (h==null) return '--:--'; var hh=Math.floor(h), mm=Math.floor((h-hh)*60); return (hh<10?'0':'')+hh+'h'+(mm<10?'0':'')+mm; }
  return { rise: fmt(calc(true)), set: fmt(calc(false)) };
}

function applyTzOffset(utcStr, offsetSec) {
  // utcStr = "HHhMM", offsetSec = seconds east of UTC
  if (!utcStr || utcStr === '--:--') return utcStr;
  var parts = utcStr.split('h');
  var totalMin = parseInt(parts[0]) * 60 + parseInt(parts[1] || 0) + Math.round(offsetSec / 60);
  totalMin = ((totalMin % 1440) + 1440) % 1440;
  var hh = Math.floor(totalMin / 60), mm = totalMin % 60;
  return (hh < 10 ? '0' : '') + hh + 'h' + (mm < 10 ? '0' : '') + mm;
}

function renderAstro(lat, lon, yr, mo, da) {
  var moon=lunarPhase(yr, mo+1, da), sun=sunriseSunset(lat, lon, yr, mo+1, da);
  var offset = typeof _locTzOffset !== 'undefined' ? _locTzOffset : 0;
  var riseLocal = applyTzOffset(sun.rise, offset);
  var setLocal  = applyTzOffset(sun.set,  offset);
  var tzLabel   = offset === 0 ? 'UTC' : (offset > 0 ? 'UTC+' : 'UTC') + (offset/3600).toFixed(1).replace('.0','');
  document.getElementById('astro-moon-ico').innerHTML = moon.svg;
  document.getElementById('astro-moon-name').textContent = moon.name;
  document.getElementById('astro-rise').textContent = riseLocal;
  document.getElementById('astro-set').textContent = setLocal;
  // Update labels
  var riseEl = document.getElementById('astro-rise').parentElement && document.getElementById('astro-rise').nextElementSibling;
  var lblEls = document.querySelectorAll('.astro-lbl');
  for (var i=0; i<lblEls.length; i++) {
    if (lblEls[i].textContent.indexOf('Lever') >= 0) lblEls[i].textContent = 'Lever soleil (' + tzLabel + ')';
    if (lblEls[i].textContent.indexOf('Coucher') >= 0) lblEls[i].textContent = 'Coucher soleil (' + tzLabel + ')';
  }
}

function applyHorizonWording(diffDays) {
  var label = document.getElementById('r-horizon-label');
  var btn   = document.getElementById('btn-go');
  var btnTxt = btn.querySelector('span') || btn;

  var span = document.getElementById('btn-go-text');
  if (diffDays === 0) {
    label.className = 'hero-horizon-label hl-real';
    label.textContent = "Aujourd'hui ‚Äî m√©t√©o en direct";
    if (span) span.textContent = "Voir la m√©t√©o";
  } else if (diffDays >= 1 && diffDays <= 7) {
    label.className = 'hero-horizon-label hl-real';
    label.textContent = 'Pr√©vision m√©t√©o r√©elle';
    if (span) span.textContent = 'Voir la m√©t√©o';
  } else if (diffDays <= 210) {
    label.className = 'hero-horizon-label hl-tendency';
    label.textContent = 'Tendance saisonni√®re ‚Äî indicatif';
    if (span) span.textContent = 'Voir la m√©t√©o';
  } else {
    label.className = 'hero-horizon-label hl-profile';
    label.textContent = 'Profil climatique historique';
    if (span) span.textContent = 'Voir la m√©t√©o';
  }
}
function setConfBadge(diffDays) { /* badge supprim√© */ }

/* GEOCODE */
function geocode(city) {
  // Strip formatting artifacts like 'Porto, Porto (Portugal)' ‚Üí 'Porto'
  var clean = city.replace(/\s*\([^)]*\)/g, '').split(',')[0].trim();
  return fetch('https://geocoding-api.open-meteo.com/v1/search?name=' + encodeURIComponent(clean) + '&count=5&language=fr')
    .then(function(r) { return r.json(); })
    .then(function(d) {
      if (!d.results || !d.results.length) throw new Error('Ville introuvable');
      var r = d.results[0];
      var gRegion = (r.country_code === 'FR') ? '' : (r.admin1 || '');
      return { lat: r.latitude, lon: r.longitude, name: r.name, region: gRegion, country: r.country || COUNTRY_NAMES[r.country_code] || r.country_code || '' };
    });
}

/* ‚îÄ‚îÄ SEA SURFACE TEMPERATURE ‚îÄ‚îÄ */
var SEA_NAME_MAP = {
  'nice':'nice','marseille':'marseille','barcelone':'barcelona','rome':'rome',
  'ath√®nes':'athens','mykonos':'mykonos','santorin':'santorini','rhodes':'rhodes',
  'ibiza':'ibiza','malte':'malta','vallette':'malta','la valette':'malta',
  'lisbonne':'lisbon','porto':'porto','biarritz':'biarritz','tenerife':'tenerife',
  'fuerteventura':'fuerteventura','lanzarote':'lanzarote',
  'grande canarie':'gran-canaria','gran canaria':'gran-canaria',
  'londres':'london','amsterdam':'amsterdam','rotterdam':'rotterdam',
  'canc√∫n':'cancun','cancun':'cancun','barbade':'barbados','maldives':'maldives',
  '√Æle maurice':'mauritius','maurice':'mauritius','zanzibar':'zanzibar',
  'duba√Ø':'dubai','dubai':'dubai','goa':'goa','phuket':'phuket','bali':'bali',
  'agadir':'agadir','le cap':'cape-town','cape town':'cape-town',
  'miami':'miami','los angeles':'los-angeles','new york':'new-york',
  'san francisco':'san-francisco','sydney':'sydney','melbourne':'melbourne',
  'stockholm':'stockholm','dublin':'dublin','venise':'venice',
  'split':'split','dubrovnik':'dubrovnik','kotor':'kotor','naples':'naples',
  'palerme':'palermo','cagliari':'cagliari','bastia':'bastia','ajaccio':'ajaccio'
};
function slugFromName(name) {
  if (!name) return null;
  var n = name.toLowerCase()
    .replace(/[√†√¢√§]/g,'a').replace(/[√©√®√™√´]/g,'e').replace(/[√Æ√Ø]/g,'i')
    .replace(/[√¥√∂]/g,'o').replace(/[√π√ª√º]/g,'u').replace(/√ß/g,'c')
    .replace(/[^a-z0-9 -]/g,'').trim();
  return SEA_NAME_MAP[n] || SEA_CLIM_DATA[n] ? (SEA_NAME_MAP[n] || n) : null;
}

var SEA_CLIM_DATA = {
  'nice':[13,13,13,15,18,22,25,26,24,21,18,15],
  'marseille':[13,13,13,14,17,21,24,25,23,20,17,14],
  'barcelona':[13,13,13,14,17,21,24,26,24,21,17,14],
  'rome':[14,13,13,14,17,21,24,26,25,22,18,15],
  'athens':[16,15,15,16,19,23,26,27,26,23,20,17],
  'mykonos':[16,15,15,16,19,23,26,27,26,23,20,17],
  'santorini':[16,15,15,16,19,23,26,27,26,23,20,17],
  'rhodes':[18,17,17,18,21,25,27,28,27,24,22,19],
  'ibiza':[14,13,13,14,17,22,25,26,25,22,17,15],
  'malta':[15,14,14,15,18,22,26,27,26,23,19,16],
  'lisbon':[16,15,15,15,17,19,21,22,21,20,18,16],
  'porto':[14,14,14,15,17,19,21,22,21,19,17,15],
  'biarritz':[13,13,13,14,16,19,21,22,21,19,16,14],
  'tenerife':[20,19,19,20,21,22,23,24,24,23,22,21],
  'fuerteventura':[20,19,19,20,21,22,23,24,24,23,22,21],
  'lanzarote':[20,19,19,20,21,22,23,24,24,23,22,21],
  'gran-canaria':[20,19,19,20,21,22,23,24,24,23,22,21],
  'london':[9,8,9,10,13,16,18,19,17,14,11,9],
  'amsterdam':[7,6,7,9,12,16,18,18,17,14,11,8],
  'rotterdam':[7,6,7,9,12,16,18,18,17,14,11,8],
  'cancun':[26,26,27,28,29,30,30,30,30,29,28,27],
  'riviera-maya':[26,26,27,28,29,30,30,30,30,29,28,27],
  'barbados':[27,26,27,27,28,28,29,29,29,28,28,27],
  'maldives':[29,29,30,30,30,29,29,29,29,29,29,29],
  'mauritius':[27,28,28,27,26,24,23,23,23,24,25,26],
  'zanzibar':[28,28,28,28,27,25,24,24,24,26,27,28],
  'dubai':[22,22,24,27,30,32,33,34,33,31,28,24],
  'goa':[27,27,28,30,31,30,29,29,29,29,28,27],
  'phuket':[28,28,29,30,30,29,29,29,29,28,28,28],
  'bali':[28,28,28,28,28,27,27,27,27,28,28,28],
  'agadir':[17,17,17,18,19,20,21,22,22,21,19,18],
  'cape-town':[21,21,20,19,17,16,15,15,16,17,18,20],
  'miami':[23,23,24,26,28,30,31,32,31,29,27,24],
  'los-angeles':[16,16,16,17,18,19,20,21,20,19,18,17],
  'new-york':[7,6,6,8,12,17,22,23,21,17,13,9],
  'sydney':[22,23,22,20,18,16,15,14,15,17,19,21],
  'melbourne':[18,19,18,16,14,13,12,12,12,14,15,17],
  'stockholm':[3,2,2,4,9,14,17,17,14,10,7,4],
  'dublin':[10,9,9,10,12,14,16,16,15,13,11,10]
};

function getSeaComfortFR(sst) {
  if (sst >= 28) return {lbl:'Tr√®s chaude',    color:'#ef4444'};
  if (sst >= 24) return {lbl:'Chaude ¬∑ baignade agr√©able', color:'#f59e0b'};
  if (sst >= 20) return {lbl:'Agr√©able',        color:'#16a34a'};
  if (sst >= 17) return {lbl:'Fra√Æche',         color:'#0ea5e9'};
  if (sst >= 14) return {lbl:'Froide',          color:'#6366f1'};
  return              {lbl:'Tr√®s froide',        color:'#64748b'};
}

function fetchMarineSST(lat, lon, yr, mo, da, slug) {
  var dateStr = yr+'-'+(mo<9?'0':'')+(mo+1)+'-'+(da<10?'0':'')+da;
  var today = new Date(); today.setHours(0,0,0,0);
  var target = new Date(yr,mo,da,0,0,0);
  var diffDays = Math.round((target.getTime()-today.getTime())/86400000);

  function tryFallback() {
    var climData = slug && SEA_CLIM_DATA[slug] ? SEA_CLIM_DATA[slug] : null;
    if (climData && climData[mo] !== null) return Promise.resolve({sst:climData[mo],fallback:true});
    return Promise.resolve(null);
  }

  var refDate = new Date(2024,0,1);
  if (diffDays > 7 || target < refDate) return tryFallback();

  var url;
  if (diffDays === 0 || (diffDays >= 1 && diffDays <= 7)) {
    url = 'https://marine-api.open-meteo.com/v1/marine?latitude='+lat+'&longitude='+lon+'&hourly=sea_surface_temperature&forecast_days=8';
  } else {
    url = 'https://marine-api.open-meteo.com/v1/marine?latitude='+lat+'&longitude='+lon+'&hourly=sea_surface_temperature&start_date='+dateStr+'&end_date='+dateStr;
  }

  return fetch(url)
    .then(function(r){ return r.ok ? r.json() : null; })
    .then(function(d){
      if (!d || d.error) return tryFallback();
      var vals = (d.hourly && d.hourly.sea_surface_temperature) || [];
      var times = (d.hourly && d.hourly.time) || [];
      var sst = null;
      if (diffDays === 0) {
        var prefix = dateStr.slice(0,13);
        for (var i=0;i<times.length;i++){if(times[i].indexOf(prefix)===0&&vals[i]!=null){sst=vals[i];break;}}
        if(sst===null)for(var j=0;j<vals.length;j++){if(vals[j]!=null){sst=vals[j];break;}}
      } else if (diffDays >= 1 && diffDays <= 7) {
        var prefix = dateStr+'T12';
        for (var i=0;i<times.length;i++) {
          if (times[i].indexOf(prefix)===0 && vals[i]!=null) { sst=vals[i]; break; }
        }
        if (sst===null) for (var j=0;j<vals.length;j++) { if (vals[j]!=null) { sst=vals[j]; break; } }
      } else {
        for (var k=0;k<vals.length;k++) { if (vals[k]!=null) { sst=vals[k]; break; } }
      }
      if (sst===null) return tryFallback();
      return {sst: Math.round(sst*10)/10, fallback:false};
    })
    .catch(function(){ return tryFallback(); });
}

function renderSeaChip(sstResult) {
  if (!sstResult || sstResult.sst===null) return;
  var comfort = getSeaComfortFR(sstResult.sst);
  var lbl = sstResult.fallback ? 'üåä Mer (norm. sais.)' : 'üåä Mer';
  var chip = document.createElement('div');
  chip.className = 'score-chip';
  chip.id = 'sea-chip';
  chip.title = comfort.lbl;
  chip.innerHTML =
    '<span class="score-chip-dot" style="background:'+comfort.color+'"></span>'+
    '<span class="score-chip-lbl">'+lbl+'</span>'+
    '<span class="score-chip-val">'+sstResult.sst+'¬∞C</span>';
  var chipsEl = document.getElementById('score-chips');
  if (chipsEl) chipsEl.appendChild(chip);
}

function fetchForecast(lat, lon, yr, mo, da) {
  var url='https://api.open-meteo.com/v1/forecast?latitude='+lat+'&longitude='+lon+'&hourly=temperature_2m,precipitation_probability,precipitation,snowfall,windspeed_10m,shortwave_radiation&timezone=auto&forecast_days=7';
  // _locTzOffset is global
  return fetch(url).then(function(r){if(!r.ok)throw new Error('Pr√©visions indisponibles');return r.json();}).then(function(data){
    if (data.utc_offset_seconds != null) _locTzOffset = data.utc_offset_seconds;
    var mo2=mo+1, prefix=yr+'-'+(mo2<10?'0':'')+mo2+'-'+(da<10?'0':'')+da, rows=[];
    for(var h=0;h<24;h++){
      var ts=prefix+'T'+(h<10?'0':'')+h+':00', idx=-1;
      for(var i=0;i<data.hourly.time.length;i++){if(data.hourly.time[i]===ts){idx=i;break;}}
      var t=idx>=0&&data.hourly.temperature_2m[idx]!=null?parseFloat(data.hourly.temperature_2m[idx].toFixed(1)):null;
      var rn=idx>=0&&data.hourly.precipitation_probability[idx]!=null?data.hourly.precipitation_probability[idx]:0;
      var mm_val=idx>=0&&data.hourly.precipitation&&data.hourly.precipitation[idx]!=null?parseFloat(data.hourly.precipitation[idx].toFixed(2)):0;
      var snow_val=idx>=0&&data.hourly.snowfall&&data.hourly.snowfall[idx]!=null?parseFloat(data.hourly.snowfall[idx].toFixed(2)):0;
      var w=idx>=0&&data.hourly.windspeed_10m[idx]!=null?parseFloat(data.hourly.windspeed_10m[idx].toFixed(1)):0;
      var s=idx>=0&&data.hourly.shortwave_radiation&&data.hourly.shortwave_radiation[idx]!=null?Math.max(0,data.hourly.shortwave_radiation[idx]):0;
      rows.push({h:h,label:(h<10?'0':'')+h+'h',p25:t,p50:t,p75:t,temp:t,rain:rn,mm:mm_val,windP50:w,solP25:s,solP50:s,solP75:s,sol:s,snow:snow_val,isForecast:true});
    }
    return rows;
  });
}

function fetchArchive(lat, lon, refDate) {
  var s=toISO(addDays(refDate,-10)), e=toISO(addDays(refDate,10));
  return fetch('https://archive-api.open-meteo.com/v1/archive?latitude='+lat+'&longitude='+lon+'&start_date='+s+'&end_date='+e+'&hourly=temperature_2m,precipitation,snowfall,windspeed_10m,shortwave_radiation&timezone=auto').then(function(r){if(!r.ok)throw new Error('Archive error');return r.json();}).then(function(d){if(d.utc_offset_seconds!=null)_locTzOffset=d.utc_offset_seconds;return d;});
}

function buildClimatology(lat, lon, yr, mo, da) {
  var target=new Date(yr,mo,da,12,0,0), now=new Date();
  var trend=Math.max(0,(target.getTime()-now.getTime())/(1000*60*60*24*365.25))*0.03;
  var endYr=now.getFullYear()-1, years=[];
  for(var y=endYr-9;y<=endYr;y++) years.push(y);
  var buckets=[]; for(var h=0;h<24;h++) buckets.push({t:[],p:[],w:[],s:[],sn:[]});
  var idx=0;
  function step(){
    if(idx>=years.length) return Promise.resolve(buildRows(buckets,trend));
    var yr2=years[idx++];
    return fetchArchive(lat,lon,new Date(yr2,mo,da,12,0,0)).then(function(data){
      var T=data.hourly.temperature_2m, P=data.hourly.precipitation, W=data.hourly.windspeed_10m, S=data.hourly.shortwave_radiation||[], SN=data.hourly.snowfall||[];
      for(var i=0;i<data.hourly.time.length;i++){var hh=new Date(data.hourly.time[i]).getHours();if(T[i]!=null)buckets[hh].t.push(T[i]);if(P[i]!=null)buckets[hh].p.push(P[i]);if(W[i]!=null)buckets[hh].w.push(W[i]);if(S[i]!=null)buckets[hh].s.push(S[i]);if(SN[i]!=null)buckets[hh].sn.push(SN[i]);}
    }).catch(function(){}).then(function(){setP(Math.round((idx/years.length)*90),'Analyse '+yr2+'‚Ä¶');return new Promise(function(res){setTimeout(res,20);});}).then(step);
  }
  return step();
}

function buildRows(buckets, trend) {
  var rows=[];
  for(var h=0;h<24;h++){
    var b=buckets[h], wet=0;
    for(var i=0;i<b.p.length;i++) if(b.p[i]>0.1) wet++;
    var p25=pct(b.t,25), p50=pct(b.t,50), p75=pct(b.t,75);
    var avgSnow = b.sn && b.sn.length > 0 ? b.sn.reduce(function(s,v){return s+v;},0)/b.sn.length : 0;
    rows.push({h:h,label:(h<10?'0':'')+h+'h',p25:p25!=null?parseFloat((p25+trend).toFixed(1)):null,p50:p50!=null?parseFloat((p50+trend).toFixed(1)):null,p75:p75!=null?parseFloat((p75+trend).toFixed(1)):null,temp:p50!=null?parseFloat((p50+trend).toFixed(1)):null,rain:b.p.length>0?Math.round(wet/b.p.length*100):0,mm:b.p.length>0?(b.p.reduce(function(s,v){return s+v;},0)/b.p.length):0,snow:avgSnow,windP50:pct(b.w,50),solP25:Math.max(0,pct(b.s,25)||0),solP50:Math.max(0,pct(b.s,50)||0),solP75:Math.max(0,pct(b.s,75)||0),sol:Math.max(0,pct(b.s,50)||0)});
  }
  return rows;
}

function fetchSeasonal(lat, lon, yr, mo, da) {
  var mo2=mo+1, mm=(mo2<10?'0':'')+mo2, dd=(da<10?'0':'')+da, dateStr=yr+'-'+mm+'-'+dd;
  return fetch('https://seasonal-api.open-meteo.com/v1/seasonal?latitude='+lat+'&longitude='+lon+'&daily=temperature_2m_mean,precipitation_sum,windspeed_10m_mean&start_date='+dateStr+'&end_date='+dateStr)
    .then(function(r){if(!r.ok)return null;return r.json();})
    .then(function(data){
      if(!data||!data.daily||!data.daily.time||data.daily.time[0]!==dateStr) return null;
      var daily=data.daily, ks=Object.keys(daily), tempM=[],precipM=[],windM=[];
      for(var i=0;i<ks.length;i++){var k=ks[i];if(k.indexOf('temperature_2m_mean_member')===0&&daily[k][0]!=null)tempM.push(daily[k][0]);if(k.indexOf('precipitation_sum_member')===0&&daily[k][0]!=null)precipM.push(daily[k][0]);if(k.indexOf('windspeed_10m_mean_member')===0&&daily[k][0]!=null)windM.push(daily[k][0]);}
      if(!tempM.length) return null;
      tempM.sort(function(a,b){return a-b;}); precipM.sort(function(a,b){return a-b;});
      var n=tempM.length, wet=0; for(var j=0;j<precipM.length;j++) if(precipM[j]>0.1) wet++;
      var windSum=0; for(var w=0;w<windM.length;w++) windSum+=windM[w];
      return {tMean:daily.temperature_2m_mean[0]||tempM[Math.floor(n*0.5)],tP25:tempM[Math.floor(n*0.25)],tP50:tempM[Math.floor(n*0.50)],tP75:tempM[Math.floor(n*0.75)],rainProb:precipM.length?Math.round(wet/precipM.length*100):null,windMean:windM.length?windSum/windM.length:null};
    }).catch(function(){return null;});
}

function applySeasonalCorrection(rows, seas) {
  if(!seas) return rows;
  var histSum=0,histCnt=0,histRainSum=0,histWindSum=0,histSpreadSum=0,spreadCnt=0;
  for(var i=0;i<rows.length;i++){var r=rows[i];if(r.p50!=null){histSum+=r.p50;histCnt++;}histRainSum+=r.rain;if(r.windP50)histWindSum+=r.windP50;if(r.p25!=null&&r.p75!=null){histSpreadSum+=(r.p75-r.p25)/2;spreadCnt++;}}
  if(!histCnt) return rows;
  var histMean=histSum/histCnt, offset=parseFloat((seas.tMean-histMean).toFixed(2));
  var histSpreadAvg=spreadCnt?histSpreadSum/spreadCnt:1, seasSpread=(seas.tP75-seas.tP25)/2;
  var ratio=(histSpreadAvg>0.5&&seasSpread>0)?Math.min(2.5,Math.max(0.3,seasSpread/histSpreadAvg)):1;
  var histRainAvg=histRainSum/rows.length, histWindAvg=rows.length?histWindSum/rows.length:0;
  var out=[];
  for(var j=0;j<rows.length;j++){
    var ro=rows[j], newP50=ro.p50!=null?ro.p50+offset:null;
    var sp25=ro.p50!=null&&ro.p25!=null?ro.p50-ro.p25:0, sp75=ro.p50!=null&&ro.p75!=null?ro.p75-ro.p50:0;
    var newRain=ro.rain;
    if(seas.rainProb!==null){var f=histRainAvg>0?Math.min(3,Math.max(0.1,seas.rainProb/histRainAvg)):1;newRain=Math.min(100,Math.max(0,Math.round(ro.rain*f*0.6+seas.rainProb*0.4)));}
    var newWind=ro.windP50;
    if(seas.windMean!==null&&ro.windP50!=null){newWind=Math.max(0,parseFloat((ro.windP50+seas.windMean-histWindAvg).toFixed(1)));}
    out.push(cloneRow(ro,{p50:newP50!=null?parseFloat(newP50.toFixed(1)):null,p25:newP50!=null?parseFloat((newP50-sp25*ratio).toFixed(1)):null,p75:newP50!=null?parseFloat((newP50+sp75*ratio).toFixed(1)):null,temp:newP50!=null?parseFloat(newP50.toFixed(1)):null,sol:ro.solP50||0,rain:newRain,windP50:newWind}));
  }
  return out;
}

function showSection(id){document.getElementById(id).style.display='block';}
function hideSection(id){document.getElementById(id).style.display='none';}

function renderHourly(sc) {
  var strip=document.getElementById('h-strip'); strip.innerHTML='';
  var hours=[0,3,6,9,12,15,18,21,23];
  for(var i=0;i<hours.length;i++){
    var r=sc[hours[i]]; if(!r) continue;
    var lbl=(hours[i]===23)?'00h':r.label;
    var cell=document.createElement('div'); cell.className='h-cell';
    cell.innerHTML='<span class="h-hr">'+lbl+'</span><span class="h-ic">'+getIcon(r.h,r.temp,r.sol,r.rain,r.mm||0,r.snow||0,r.p25)+'</span><span class="h-tp">'+(r.temp!=null?r.temp+'\u00b0':'-')+'</span><span class="h-lb">'+getLabel(r.h,r.temp,r.sol,r.rain,r.mm||0,r.snow||0)+'</span><div class="h-rb"><div class="h-rf" style="width:'+r.rain+'%"></div></div>';
    strip.appendChild(cell);
  }
}


function scenarioLabel(rows, isOpt) {
  var temps = [], rains = [];
  for (var i=0; i<rows.length; i++) {
    if (rows[i].temp != null) temps.push(rows[i].temp);
    rains.push(rows[i].rain);
  }
  var tmax = temps.length ? Math.max.apply(null,temps) : null;
  var tmin = temps.length ? Math.min.apply(null,temps) : null;
  var avgRain = rains.length ? rains.reduce(function(a,b){return a+b;},0)/rains.length : 0;

  var title, sub;
  if (isOpt) {
    // Optimistic scenario
    if (tmax !== null && tmax >= 38)      { title = 'Journ√©e tr√®s chaude';  sub = 'Chaleur intense ¬∑ peu de pluie'; }
    else if (tmax !== null && tmax >= 32) { title = 'Journ√©e chaude';        sub = 'Chaud ¬∑ ensoleill√©'; }
    else if (tmax !== null && tmax <= 5)  { title = 'Journ√©e froide';        sub = 'Froid ¬∑ peu de pr√©cipitations'; }
    else if (avgRain <= 15)               { title = 'Belle journ√©e';          sub = 'Ensoleill√© ¬∑ peu de pluie'; }
    else                                  { title = 'Journ√©e correcte';       sub = 'Conditions acceptables'; }
  } else {
    // Pessimistic scenario
    if (avgRain >= 60)                    { title = 'Journ√©e tr√®s pluvieuse'; sub = 'Pluie fr√©quente'; }
    else if (tmax !== null && tmax >= 38) { title = 'Canicule';               sub = 'Chaleur extr√™me ¬∑ risque sanitaire'; }
    else if (tmin !== null && tmin <= 0)  { title = 'Journ√©e glaciale';       sub = 'Gel possible ¬∑ conditions difficiles'; }
    else if (avgRain >= 35)               { title = 'Journ√©e difficile';       sub = 'Pluie ¬∑ temp√©ratures fra√Æches'; }
    else                                  { title = 'Journ√©e mitig√©e';         sub = "Nuageux ¬∑ risque d'averses"; }
  }
  return { title: title, sub: sub };
}

function updateScenarioLabels(pessRows, optRows) {
  var pess = scenarioLabel(pessRows, false);
  var opt  = scenarioLabel(optRows,  true);
  var pt = document.getElementById('sc-pess-ttl');
  var ps = document.getElementById('sc-pess-sub');
  var ot = document.getElementById('sc-opt-ttl');
  var os = document.getElementById('sc-opt-sub');
  if (pt) pt.textContent = pess.title;
  if (ps) ps.textContent = pess.sub;
  if (ot) ot.textContent = opt.title;
  if (os) os.textContent = opt.sub;
}

function renderScCard(sc, stripId, statsId) {
  var strip=document.getElementById(stripId); strip.innerHTML='';
  var hours=[0,3,6,9,12,15,18,21,23];
  for(var i=0;i<hours.length;i++){
    var r=sc[hours[i]]; if(!r) continue;
    var lbl=(hours[i]===23)?'00h':r.label;
    var cell=document.createElement('div'); cell.className='sc-cell';
    cell.innerHTML='<span class="sc-hr">'+lbl+'</span>'+getIcon(r.h,r.temp,r.sol,r.rain,r.mm||0,r.snow||0,r.p25)+'<span class="sc-tp">'+(r.temp!=null?r.temp+'\u00b0':'-')+'</span>';
    strip.appendChild(cell);
  }
  var temps=[],rSum=0,wSum=0;
  for(var j=0;j<sc.length;j++){if(sc[j].temp!=null)temps.push(sc[j].temp);rSum+=sc[j].rain;wSum+=(sc[j].windP50||0);}
  var tmin=temps.length?Math.min.apply(null,temps):'-', tmax=temps.length?Math.max.apply(null,temps):'-';
  document.getElementById(statsId).innerHTML='<div><div class="sc-stat-val">'+tmin+'\u00b0/'+tmax+'\u00b0</div><div class="sc-stat-lbl">Mini/Maxi</div></div><div><div class="sc-stat-val">'+Math.round(rSum/sc.length)+'%</div><div class="sc-stat-lbl">Pluie</div></div><div><div class="sc-stat-val">'+Math.round(wSum/sc.length)+' km/h</div><div class="sc-stat-lbl">Vent</div></div>';
}


/* ‚îÄ‚îÄ SCORE M√âT√âO PROJET ‚îÄ‚îÄ */
var currentUseCase = 'general';
var _lastRows = null, _lastSc = null;
var _locTzOffset = 0; // global timezone offset from API
var _lastMonthly = null, _lastAnnLoc = null;

var UC_CONFIG = {
  mariage:  { label:'Mariage & r√©ception', tempMin:16, tempMax:28, weights:{rain:40,temp:30,wind:20,sun:10} },
  voyage:   { label:'Voyage & tourisme',   tempMin:10, tempMax:32, weights:{rain:45,temp:25,wind:10,sun:20} },
  festival: { label:'Festival & √©v√©nement',tempMin:14, tempMax:30, weights:{rain:35,temp:25,wind:25,sun:15} },
  sport:    { label:'Sport & outdoor',     tempMin:8,  tempMax:26, weights:{rain:25,temp:20,wind:15,sun:25} },
  travaux:  { label:'Chantier & travaux',  tempMin:5,  tempMax:32, weights:{rain:40,temp:15,wind:25,sun:10} },
  general:  { label:'M√©t√©o g√©n√©rale',      tempMin:16, tempMax:28, weights:{rain:35,temp:25,wind:20,sun:20} }
};

function scoreRain(pct) {
  if (pct <= 10) return 100;
  if (pct <= 25) return 100 - (pct - 10) * 2;
  if (pct <= 50) return 70 - (pct - 25) * 1.6;
  if (pct <= 80) return 30 - (pct - 50) * 0.8;
  return Math.max(0, 6 - (pct - 80) * 0.3);
}
function scoreRainSmart(pct, mmDay, avgTemp) {
  // Correction bas√©e sur l'intensit√© r√©elle (mm/jour), ind√©pendamment de la temp√©rature.
  // < 3mm/j = bruine/averses l√©g√®res ‚Üí forte correction (pluie peu g√™nante)
  // 3‚Äì6mm/j = pluie mod√©r√©e ‚Üí correction partielle
  // > 6mm/j = pluie s√©rieuse ‚Üí pas de correction
  var effective = pct;
  if (mmDay != null) {
    if (mmDay < 3) {
      var factor = 0.40 + (mmDay / 3) * 0.30;
      effective = pct * factor;
    } else if (mmDay < 6) {
      var factor = 0.70 + ((mmDay - 3) / 3) * 0.30;
      effective = pct * factor;
    }
  }
  return scoreRain(effective);
}

function scoreTemp(t, tMin, tMax) {
  if (t == null) return 50;
  var ideal = (tMin + tMax) / 2;
  var range = (tMax - tMin) / 2;
  if (t >= tMin && t <= tMax) {
    // 100 at ideal, 80 at edges
    return 100 - 20 * Math.abs(t - ideal) / range;
  }
  // Outside range: asymmetric penalty
  // Too cold = strong penalty (8pts/¬∞C) ‚Äî comfort strongly affected
  // Too hot  = soft penalty  (2pts/¬∞C) ‚Äî still pleasant, just warm
  if (t < tMin) {
    return Math.max(0, 80 - (tMin - t) * 8);
  } else {
    return Math.max(0, 80 - (t - tMax) * 2);
  }
}

function scoreWind(kmh) {
  if (kmh <= 10) return 100;
  if (kmh <= 20) return 100 - (kmh - 10) * 3;
  if (kmh <= 40) return 70 - (kmh - 20) * 2.5;
  return Math.max(0, 20 - (kmh - 40) * 1);
}

function scoreSun(peakSol) {
  if (peakSol >= 600) return 100;
  if (peakSol >= 300) return 60 + (peakSol - 300) / 300 * 40;
  if (peakSol >= 100) return 20 + (peakSol - 100) / 200 * 40;
  return Math.max(0, peakSol / 100 * 20);
}

function getScoreColor(score) {
  if (score >= 80) return '#1a7a4a'; // green
  if (score >= 65) return '#84cc16'; // lime
  if (score >= 50) return '#f59e0b'; // amber
  if (score >= 35) return '#f97316'; // orange
  return '#ef4444';                  // red
}

function getVerdict(score, avgRain) {
  // Rain > 60% = toujours journ√©e difficile ou tr√®s pluvieuse
  if (avgRain > 70) return 'Journ√©e tr√®s pluvieuse';
  if (avgRain > 45) return score >= 75 ? 'Journ√©e pluvieuse ‚Äî conditions acceptables' : 'Journ√©e pluvieuse';
  // Rain 30‚Äì45% = averses possibles, score doit √™tre √©lev√© pour compenser
  if (avgRain > 30) {
    if (score >= 78) return 'Bonnes conditions ‚Äî averses possibles';
    if (score >= 60) return 'Conditions mitig√©es ‚Äî averses possibles';
    return 'Conditions difficiles';
  }
  // Rain < 30% = verdict bas√© sur score
  if (score >= 85) return 'Conditions excellentes';
  if (score >= 70) return 'Bonnes conditions';
  if (score >= 55) return 'Conditions acceptables';
  if (score >= 40) return 'Conditions mitig√©es';
  return 'Conditions difficiles';
}

function getMainRisk(avgRain, avgTemp, avgWind, uc) {
  var cfg = UC_CONFIG[uc] || UC_CONFIG.general;
  var risks = [];
  if (avgRain > 50) risks.push('Pluie probable (' + Math.round(avgRain) + '%)');
  else if (avgRain > 30) risks.push("Risque d'averses (" + Math.round(avgRain) + '%)');
  if (avgTemp < cfg.tempMin) risks.push('Temp√©rature fra√Æche (' + Math.round(avgTemp) + '¬∞C)');
  else if (avgTemp > cfg.tempMax) risks.push('Chaleur √©lev√©e (' + Math.round(avgTemp) + '¬∞C)');
  if (avgWind > 30) risks.push('Vent soutenu (' + Math.round(avgWind) + ' km/h)');
  if (risks.length === 0) return 'Aucun risque majeur identifi√©';
  return 'Risque : ' + risks.join(' ¬∑ ');
}

function computeAndRenderScore(sc, rows) {
  _lastRows = rows; _lastSc = sc;
  var uc = currentUseCase;
  var cfg = UC_CONFIG[uc] || UC_CONFIG.general;
  var w = cfg.weights;

  // Compute daily averages
  var rSum=0, wSum=0, tSum=0, tCnt=0, peakSol=0, mmSum=0;
  for (var i=0; i<rows.length; i++) {
    rSum += rows[i].rain;
    wSum += (rows[i].windP50 || 0);
    mmSum += (rows[i].mm || 0);
    if (rows[i].temp != null) { tSum += rows[i].temp; tCnt++; }
  }
  for (var k=0; k<sc.length; k++) if ((sc[k].sol||0) > peakSol) peakSol = sc[k].sol;

  var avgRain = rSum / rows.length;
  var avgWind = wSum / rows.length;
  var avgTemp = tCnt ? tSum / tCnt : null;

  // Individual scores
  var sRain = scoreRain(avgRain);
  var sTemp = scoreTemp(avgTemp, cfg.tempMin, cfg.tempMax);
  var sWind = scoreWind(avgWind);
  var sSun  = scoreSun(peakSol);

  // Weighted total
  var total = Math.round(
    sRain * w.rain / 100 +
    sTemp * w.temp / 100 +
    sWind * w.wind / 100 +
    sSun  * w.sun  / 100
  );
  // Normalize to 100 (weights sum to 100)
  total = Math.min(100, Math.max(0, total));

  var color = getScoreColor(total);

  // Ring animation: circumference 188.5
  var offset = 188.5 * (1 - total / 100);
  var ring = document.getElementById('score-ring');
  ring.style.stroke = color;
  setTimeout(function() { ring.style.strokeDashoffset = offset; }, 50);

  document.getElementById('score-num').textContent = total;
  var ucLabels = {
    mariage:'Score optimis√© ¬∑ Mariage', voyage:'Score optimis√© ¬∑ Voyage', festival:'Score optimis√© ¬∑ Festival',
    sport:'Score optimis√© ¬∑ Outdoor', travaux:'Score optimis√© ¬∑ Travaux', general:'M√©t√©o g√©n√©rale'
  };
  if (uc === 'general') {
    document.getElementById('score-usecase').textContent = 'Score m√©t√©o g√©n√©ral';
    document.getElementById('score-risk').innerHTML = '<span style="color:var(--gold);font-size:11px;font-weight:600">&#8593; Cliquez sur un projet pour un score personnalis√©</span>';
  } else {
    document.getElementById('score-usecase').textContent = ucLabels[uc] || cfg.label;
  }
  document.getElementById('score-verdict').textContent = getVerdict(total, avgRain);
  document.getElementById('score-verdict').style.color = color;
  updateScoreTooltip(uc);
  document.getElementById('score-risk').textContent = getMainRisk(avgRain, avgTemp, avgWind, uc);

  // Detail chips ‚Äî show actual values with colored dot
  var totalMm = Math.round(mmSum * 10) / 10;
  var totalSnow = 0; for (var _s=0; _s<rows.length; _s++) { totalSnow += (rows[_s].snow || 0); } totalSnow = Math.round(totalSnow * 10) / 10;
  var chips = [
    { lbl: 'Pluie',   val: Math.round(avgRain)+'%',            score: sRain },
    { lbl: 'Pr√©cip.', val: totalMm > 0 ? totalMm + ' mm' : '0 mm', score: sRain },
    { lbl: 'Temp.',   val: avgTemp!=null?Math.round(avgTemp)+'¬∞C':'‚Äì', score: sTemp },
    { lbl: 'Vent',    val: Math.round(avgWind)+' km/h',         score: sWind }
  
  ];
  if (totalSnow > 0.5) chips.push({ lbl: 'Neige', val: totalSnow + ' cm', score: 0, color: '#6366f1' });
  var chipsEl = document.getElementById('score-chips');
  chipsEl.innerHTML = '';
  for (var b=0; b<chips.length; b++) {
    var chipColor = chips[b].color || getScoreColor(chips[b].score);
    var chip = document.createElement('div');
    chip.className = 'score-chip';
    chip.innerHTML =
      '<span class="score-chip-dot" style="background:'+chipColor+'"></span>' +
      '<span class="score-chip-lbl">' + chips[b].lbl + '</span>' +
      '<span class="score-chip-val">' + chips[b].val + '</span>';
    chipsEl.appendChild(chip);
  }
  // R√©-injecter le chip SST s'il a d√©j√† √©t√© r√©cup√©r√©
  if (window._lastSSTResult) renderSeaChip(window._lastSSTResult);
}

function updateHero(sc, rows) {
  var main=sc[13]||sc[12];
  var temps=[]; for(var i=0;i<sc.length;i++) if(sc[i].temp!=null) temps.push(sc[i].temp);
  var tmin=temps.length?Math.min.apply(null,temps):'-', tmax=temps.length?Math.max.apply(null,temps):'-';
  var rSum=0,wSum=0,peakSol=0;
  for(var j=0;j<rows.length;j++){rSum+=rows[j].rain;wSum+=(rows[j].windP50||0);}
  for(var k=0;k<sc.length;k++) if((sc[k].sol||0)>peakSol) peakSol=sc[k].sol;
  var avgRain=Math.round(rSum/rows.length);
  var skyLbl;
  if(avgRain>55)skyLbl='Pluvieux';else if(avgRain>35)skyLbl='Nuageux';else if(peakSol>500&&avgRain<20)skyLbl='Plein soleil';else if(peakSol>250&&avgRain<30)skyLbl='Ensoleill√©';else if(peakSol>80)skyLbl='Voil√©';else if(peakSol>15)skyLbl='Nuageux';else skyLbl='Couvert';
  document.getElementById('r-temp').innerHTML=(main.temp||'-')+'<sup>\u00b0</sup>';
  document.getElementById('r-range').textContent=tmin+'\u00b0 / '+tmax+'\u00b0 dans la journ√©e';
  document.getElementById('r-cond').textContent=getLabel(main.h,main.temp,main.sol,main.rain,main.mm||0,main.snow||0,main.p25);
  document.getElementById('r-icon').innerHTML=getIcon(main.h,main.temp,main.sol,main.rain,main.mm||0,main.snow||0,main.p25);
  document.getElementById('r-rain').textContent=avgRain+'%';
  document.getElementById('r-wind').textContent=Math.round(wSum/rows.length)+' km/h';
  document.getElementById('r-sky').textContent=skyLbl;
  computeAndRenderScore(sc, rows);

  // Alerte neige
  var _snowAlert = document.getElementById('snow-alert');
  if (!_snowAlert) {
    _snowAlert = document.createElement('div');
    _snowAlert.id = 'snow-alert';
    _snowAlert.style.cssText = 'background:#ede9fe;border:1.5px solid #6366f1;border-radius:10px;padding:8px 14px;font-size:13px;font-weight:700;color:#4f46e5;display:none;margin-top:10px;text-align:center';
    var heroTop = document.querySelector('.hero-top');
    if (heroTop) heroTop.appendChild(_snowAlert);
  }
  var _snowRows = rows || sc;
  var _snowTotal = 0; for (var _si=0; _si<_snowRows.length; _si++) _snowTotal += (_snowRows[_si].snow||0);
  var _snowHours = 0;
  if (_snowTotal < 0.5) {
    for (var _si=0; _si<_snowRows.length; _si++) {
      var _r = _snowRows[_si];
      var _t = (_r.p25 != null ? _r.p25 : _r.temp) || 99;
      if (_t <= 2 && (_r.mm||0) > 0.1 && (_r.rain||0) > 15) _snowHours++;
    }
  }
  if (_snowTotal > 0.5) {
    _snowAlert.style.display = 'block';
    _snowAlert.textContent = '‚ùÑÔ∏è Neige pr√©vue ¬∑ ' + Math.round(_snowTotal*10)/10 + ' cm au total';
  } else if (_snowHours >= 2) {
    _snowAlert.style.display = 'block';
    _snowAlert.textContent = '‚ùÑÔ∏è Neige probable ¬∑ ' + _snowHours + 'h de pr√©cipitations sous 2¬∞C';
  } else if (_snowHours >= 1) {
    _snowAlert.style.display = 'block';
    _snowAlert.textContent = '‚ùÑÔ∏è Neige possible ¬∑ temp√©ratures proches du gel avec pr√©cipitations';
  } else {
    _snowAlert.style.display = 'none';
  }
}

function showResults(sc, rows, isForecast, noteText, diffDays) {
  setConfBadge(diffDays);
  applyHorizonWording(diffDays);
  document.getElementById('score-block').style.display = 'block';
  showSection('hero');
  document.getElementById('uc-filter-wrap').style.display='block';
  showSection('sec-hourly');
  renderHourly(sc);
  if(!isForecast){
    showSection('sec-scenarios');
    var pessRows = genPess(rows);
    var optRows  = genOpt(rows);
    renderScCard(pessRows,'sc-pess-strip','sc-pess-stats');
    renderScCard(optRows,'sc-opt-strip','sc-opt-stats');
    updateScenarioLabels(pessRows, optRows);
  }
  if(noteText){var fn=document.getElementById('foot-note');fn.innerHTML=noteText;fn.style.display='block';}
}

/* AUTOCOMPLETE */
var acTimer=null, acIdx=-1, acData=[], selectedLoc=null;
function flagEmoji(code){
  if(!code||code.length!==2)return'';
  return '<span style="display:inline-block;min-width:20px;padding:0 3px;height:14px;line-height:14px;background:#e2e8f0;border-radius:2px;font-size:8px;font-weight:700;color:#4a5568;text-align:center;vertical-align:middle;margin-right:4px">'+code.toUpperCase()+'</span>';
}

function hideAC(){document.getElementById('ac-list').style.display='none';acIdx=-1;}
function showAC(items){
  // Trier par population d√©croissante ‚Äî la grande ville passe avant le hameau homonyme
  var sorted = (items||[]).slice().sort(function(a,b){ return (b.population||0)-(a.population||0); });
  acData=sorted;acIdx=-1;var list=document.getElementById('ac-list');list.innerHTML='';
  if(!acData.length){list.style.display='none';return;}
  for(var i=0;i<acData.length;i++){(function(item,pos){var div=document.createElement('div');div.className='ac-item';var sub=getAcSub(item);div.innerHTML='<span>'+flagEmoji(item.country_code)+' '+item.name+'</span><span class="ac-sub">'+sub+'</span>';div.onmousedown=function(e){e.preventDefault();selectAC(pos);};list.appendChild(div);})(acData[i],i);}
  list.style.display='block';
}


var COUNTRY_NAMES = {
  'GP':'Guadeloupe','MQ':'Martinique','RE':'La R√©union','GF':'Guyane',
  'YT':'Mayotte','PM':'Saint-Pierre-et-Miquelon','NC':'Nouvelle-Cal√©donie',
  'PF':'Polyn√©sie fran√ßaise','WF':'Wallis-et-Futuna','BL':'Saint-Barth√©lemy','MF':'Saint-Martin'
};
function getCountryName(item) {
  return item.country || COUNTRY_NAMES[item.country_code] || item.country_code || '';
}

var DOMTOM_CODES = ['GP','MQ','RE','GF','YT','PM','NC','PF','WF','BL','MF'];
function isFranceMetro(item) {
  // France m√©tro : lat 41-52, lon -5.5 √† 10
  if (item.country_code !== 'FR') return false;
  var lat = parseFloat(item.latitude), lon = parseFloat(item.longitude);
  return lat >= 41 && lat <= 52 && lon >= -5.5 && lon <= 10;
}


var COUNTRY_NAMES = {
  'GP':'Guadeloupe','MQ':'Martinique','RE':'La R√©union','GF':'Guyane fran√ßaise',
  'YT':'Mayotte','PM':'Saint-Pierre-et-Miquelon','NC':'Nouvelle-Cal√©donie',
  'PF':'Polyn√©sie fran√ßaise','WF':'Wallis-et-Futuna','BL':'Saint-Barth√©lemy',
  'MF':'Saint-Martin','FR':'France','BE':'Belgique','CH':'Suisse','LU':'Luxembourg',
  'CA':'Canada','US':'√âtats-Unis','GB':'Royaume-Uni','DE':'Allemagne','ES':'Espagne',
  'IT':'Italie','PT':'Portugal','NL':'Pays-Bas','MA':'Maroc','TN':'Tunisie',
  'DZ':'Alg√©rie','SN':'S√©n√©gal','CI':'C√¥te d\'Ivoire','CM':'Cameroun'
};
function countryName(code, fallback) {
  return COUNTRY_NAMES[code] || fallback || code || '';
}

function getFrTerritory(lat, lon) {
  lat = parseFloat(lat); lon = parseFloat(lon);
  // France m√©tropolitaine
  if (lat >= 41 && lat <= 52 && lon >= -5.5 && lon <= 10) return null;
  // DOM-TOM par coordonn√©es
  if (lat >= 14 && lat <= 18 && lon >= -63 && lon <= -60) return 'Guadeloupe';
  if (lat >= 14 && lat <= 15 && lon >= -61.5 && lon <= -60.5) return 'Martinique';
  if (lat >= -22 && lat <= -20 && lon >= 55 && lon <= 56) return 'La R√©union';
  if (lat >= 2 && lat <= 6 && lon >= -55 && lon <= -51) return 'Guyane';
  if (lat >= -14 && lat <= -12 && lon >= 44 && lon <= 46) return 'Mayotte';
  if (lat >= -23 && lat <= -20 && lon >= 163 && lon <= 168) return 'Nouvelle-Cal√©donie';
  if (lat >= -18 && lat <= -14 && lon >= -150 && lon <= -148) return 'Polyn√©sie fran√ßaise';
  if (lat >= 46 && lat <= 48 && lon >= -57 && lon <= -52) return 'Saint-Pierre-et-Miquelon';
  return 'Outre-mer';
}

function getAcSub(item) {
  if (item.country_code === 'FR') {
    var terr = getFrTerritory(item.latitude, item.longitude);
    var region = terr || item.admin1 || '';
    return region + (region ? ', ' : '') + (item.country || 'France');
  }
  return (item.admin1 || '') + (item.admin1 && item.country ? ', ' : '') + (item.country || '');
}

function selectAC(i){
  var item=acData[i];if(!item)return;
  // Pour FR : ne jamais afficher admin1, juste le pays
  var region = (item.country_code === 'FR') ? '' : (item.admin1 || ''); // region masqu√©e dans le champ r√©sultat
  var country = getCountryName(item);
  selectedLoc={lat:item.latitude,lon:item.longitude,name:item.name,region:region,country:country};
  var label = item.name;
  if (region) label += ', ' + region;
  if (country) label += ' (' + country + ')';
  document.getElementById('inp-city').value = label;
  hideAC();
}
function normalizeQuery(s){
  // Remplacer espaces par tirets + supprimer accents pour meilleur matching API
  return s.replace(/ /g,'-').normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'');
}
function fetchAC(q){
  var hint=document.getElementById('city-hint');
  if(hint) hint.style.display='none';
  var base='https://geocoding-api.open-meteo.com/v1/search?count=6&language=fr&name=';
  var p1=fetch(base+encodeURIComponent(q)).then(function(r){return r.json();}).then(function(d){return d.results||[];});
  // Si espaces : aussi envoyer version normalis√©e (tirets + sans accents)
  var qNorm = normalizeQuery(q);
  var p2 = q.indexOf(' ')>=0
    ? fetch(base+encodeURIComponent(qNorm)).then(function(r){return r.json();}).then(function(d){return d.results||[];})
    : Promise.resolve([]);
  Promise.all([p1,p2]).then(function(both){
    var seen={}, merged=[];
    both[0].concat(both[1]).forEach(function(item){
      var key=item.name+'|'+item.latitude+'|'+item.longitude;
      if(!seen[key]){seen[key]=1;merged.push(item);}
    });
    merged.sort(function(a,b){return (b.population||0)-(a.population||0);});
    showAC(merged.slice(0,6));
  }).catch(function(){hideAC();});
}

/* RUN */
function run() {
  var city=document.getElementById('inp-city').value.trim();
  var _dateEl=document.getElementById('inp-date'); var dval=_dateEl._isoValue||_dateEl.value;
  var btnEl=document.getElementById('btn-go'), errEl=document.getElementById('err-box'), progEl=document.getElementById('prog-wrap');
  if(!city){
    errEl.textContent='‚ö† Entrez une ville ou une destination avant de continuer.';
    errEl.style.display='block';
    var cityInp=document.getElementById('inp-city');
    cityInp.style.borderColor='#dc2626';cityInp.focus();
    cityInp.addEventListener('input',function(){cityInp.style.borderColor='';errEl.style.display='none';},{once:true});
    return;
  }
  if(!dval){
    errEl.textContent='‚ö† Choisissez une date pour votre projet.';
    errEl.style.display='block';
    var dateInp=document.getElementById('inp-date');
    dateInp.style.borderColor='#dc2626';dateInp.focus();
    dateInp.addEventListener('change',function(){dateInp.style.borderColor='';errEl.style.display='none';},{once:true});
    return;
  }
  var parts=dval.split('-');
  if(parts.length!==3){errEl.textContent='‚ö† Format de date invalide.';errEl.style.display='block';return;}
  var yr=parseInt(parts[0],10), mo=parseInt(parts[1],10)-1, da=parseInt(parts[2],10);
  var today=new Date();today.setHours(0,0,0,0);
  var target=new Date(yr,mo,da,0,0,0);
  var diffDays=Math.round((target.getTime()-today.getTime())/86400000);
  btnEl.disabled=true; errEl.style.display='none';
  hideSection('hero');hideSection('sec-hourly');hideSection('sec-scenarios');
  document.getElementById('foot-note').style.display='none';
  progEl.style.display='block';setP(0,'Localisation‚Ä¶');
  // Avertir si pas de s√©lection depuis la liste (risque de mauvaise ville)
  if (!selectedLoc) {
    var errEl2 = document.getElementById('err-box');
    errEl2.textContent = '‚ö† S√©lectionnez une ville dans la liste d√©roulante pour garantir la bonne localisation.';
    errEl2.style.display = 'block';
    setTimeout(function(){errEl2.style.display='none';}, 4000);
  }
  var locP=selectedLoc?Promise.resolve(selectedLoc):geocode(city);
  locP.then(function(loc){
    setP(5,loc.name+' trouv√©‚Ä¶');
    document.getElementById('r-loc').textContent=loc.name+' ‚Äî '+(loc.country||'');
    document.getElementById('r-date').textContent=new Date(yr,mo,da,12,0,0).toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
    renderAstro(loc.lat,loc.lon,yr,mo,da);
    // Lancer SST en parall√®le (silencieux ‚Äî n'affecte pas le score principal)
    window._lastSSTResult = null;
    var slug = slugFromName(loc.name);
    fetchMarineSST(loc.lat,loc.lon,yr,mo,da,slug).then(function(sstResult){
      window._lastSSTResult = sstResult;
      var old = document.getElementById('sea-chip');
      if (old) old.parentNode.removeChild(old);
      renderSeaChip(sstResult);
    });
    if(diffDays>=0&&diffDays<=7){
      setP(30,'Pr√©visions m√©t√©o r√©elles‚Ä¶');
      return fetchForecast(loc.lat,loc.lon,yr,mo,da).then(function(rows){
        renderAstro(loc.lat,loc.lon,yr,mo,da);
        setP(100,'Termin√©');updateHero(rows,rows);showResults(rows,rows,true,'<strong>Pr√©vision r√©elle</strong> ¬∑ donn√©es m√©t√©o en temps r√©el, mise √† jour toutes les heures.',diffDays);progEl.style.display='none';btnEl.disabled=false;
      });
    }
    return buildClimatology(loc.lat,loc.lon,yr,mo,da).then(function(rows){
      if(diffDays>7&&diffDays<=210){setP(92,'Correction ECMWF saisonni√®re‚Ä¶');return fetchSeasonal(loc.lat,loc.lon,yr,mo,da).then(function(seas){return applySeasonalCorrection(rows,seas);});}
      return rows;
    }).then(function(rows){
      renderAstro(loc.lat,loc.lon,yr,mo,da);
      setP(100,'Termin√©');seedRand(makeSeed(loc.lat,loc.lon,yr,mo,da));var sc=genMain(rows);updateHero(sc,rows);
      var note=(diffDays>7&&diffDays<=210)?'<strong>Tendance saisonni√®re</strong> ¬∑ climatologie 10 ans corrig√©e par le mod√®le ECMWF ‚Äî indicatif, non garanti.':'<strong>Profil climatique</strong> ¬∑ moyenne statistique des 10 derni√®res ann√©es pour cette date et ce lieu.';
      showResults(sc,rows,false,note,diffDays);progEl.style.display='none';btnEl.disabled=false;
    });
  }).catch(function(err){errEl.textContent='Erreur : '+err.message;errEl.style.display='block';progEl.style.display='none';showSection('empty');btnEl.disabled=false;});
}


/* ‚îÄ‚îÄ TOOLTIP SCORE ‚îÄ‚îÄ */
function toggleScoreTooltip() {
  var tt = document.getElementById('score-tooltip');
  tt.classList.toggle('visible');
  // close on outside click
  if (tt.classList.contains('visible')) {
    setTimeout(function() {
      document.addEventListener('click', function closeTooltip(e) {
        if (!tt.contains(e.target) && e.target.id !== 'score-info-btn') {
          tt.classList.remove('visible');
        }
        document.removeEventListener('click', closeTooltip);
      });
    }, 10);
  }
}

function updateScoreTooltip(uc) {
  var cfg = UC_CONFIG[uc] || UC_CONFIG.general;
  var w = cfg.weights;
  var tt = document.getElementById('score-tooltip');
  var ucName = {mariage:'Mariage',voyage:'Voyage',festival:'Festival',sport:'Outdoor',travaux:'Travaux',general:'M√©t√©o g√©n√©rale'}[uc] || uc;
  tt.innerHTML =
    '<strong style="font-size:12px">Score ¬∑ ' + ucName + '</strong><br>' +
    'üíß Pluie &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + w.rain + '%<br>' +
    'üå° Temp√©rature ' + w.temp + '%<br>' +
    'üí® Vent &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + w.wind + '%<br>' +
    '‚òÄ Soleil &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + w.sun + '%<br>' +
    '<span style="opacity:.6;font-size:10px">Plage id√©ale : ' + cfg.tempMin + '‚Äì' + cfg.tempMax + '¬∞C</span>';
}

/* ‚îÄ‚îÄ RECOMMENDED BADGES (annual view) ‚îÄ‚îÄ */
function markRecommendedMonths() {
  var cards = document.querySelectorAll('.month-card');
  if (!cards.length) return;
  var uc = currentUseCase === 'general' ? null : currentUseCase;
  if (!uc) return; // no use case = no recommendation

  // Collect scores for each card
  var scores = [];
  for (var i = 0; i < cards.length; i++) {
    var monthIdx = parseInt(cards[i].dataset.monthIdx);
    scores.push({ idx: i, monthIdx: monthIdx, score: parseFloat(cards[i].dataset.score || 0) });
  }
  if (!scores.length) return;

  // Mark strictly top 1 or 2 (by rank, not by threshold)
  var topIdxs = [];
  for (var k = 0; k < Math.min(2, sorted.length); k++) {
    if (sorted[k].score >= 55) topIdxs.push(sorted[k].idx);
  }

  for (var j = 0; j < cards.length; j++) {
    if (topIdxs.indexOf(j) >= 0) {
      cards[j].classList.add('recommended');
    } else {
      cards[j].classList.remove('recommended');
    }
  }
}


/* ‚îÄ‚îÄ MODE SWITCH ‚îÄ‚îÄ */
function switchMode(mode) {
  var isDate = mode === 'date';
  document.getElementById('mode-date').className   = 'mode-btn' + (isDate ? ' active' : '');
  document.getElementById('mode-annual').className = 'mode-btn' + (!isDate ? ' active' : '');
  document.getElementById('annual-wrap').style.display  = isDate ? 'none' : 'block';
  // show/hide date-mode elements
  var dateEls = ['date-form','hero','sec-hourly','sec-scenarios','empty','foot-note','uc-filter-wrap'];
  dateEls.forEach(function(id){
    var el = document.getElementById(id);
    if (el) el.style.display = isDate ? (id === 'empty' ? 'block' : el._wasDisplay || '') : 'none';
  });
  if (isDate) document.getElementById('empty').style.display = 'block';

}

/* ‚îÄ‚îÄ ANNUAL AUTOCOMPLETE ‚îÄ‚îÄ */
var annAcTimer = null, annAcIdx = -1, annAcData = [], annSelectedLoc = null;

function hideAnnAC() { document.getElementById('ann-ac-list').style.display = 'none'; annAcIdx = -1; }
function showAnnAC(items) {
  annAcData = items || []; annAcIdx = -1;
  var list = document.getElementById('ann-ac-list'); list.innerHTML = '';
  if (!annAcData.length) { list.style.display = 'none'; return; }
  for (var i = 0; i < annAcData.length; i++) {
    (function(item, pos) {
      var div = document.createElement('div'); div.className = 'ac-item';
      var sub = getAcSub(item);
      div.innerHTML = '<span>' + flagEmoji(item.country_code) + ' ' + item.name + '</span><span class="ac-sub">' + sub + '</span>';
      div.onmousedown = function(e) { e.preventDefault(); selectAnnAC(pos); };
      list.appendChild(div);
    })(annAcData[i], i);
  }
  list.style.display = 'block';
}
function selectAnnAC(i) {
  var item = annAcData[i]; if (!item) return;
  var region2 = (item.country_code === 'FR') ? '' : (item.admin1 || '');
  var country2 = getCountryName(item);
  annSelectedLoc = { lat: item.latitude, lon: item.longitude, name: item.name, region: region2, country: country2 };
  var label2 = item.name;
  if (region2) label2 += ', ' + region2;
  if (country2) label2 += ' (' + country2 + ')';
  document.getElementById('ann-city').value = label2;
  hideAnnAC();
}

/* ‚îÄ‚îÄ ANNUAL DATA ‚îÄ‚îÄ */
function runAnnual() {
  var city = document.getElementById('ann-city').value.trim();
  if (!city) {
    err.textContent = '‚ö† Entrez une ville ou une destination avant de continuer.';
    err.style.display = 'block';
    var annInp = document.getElementById('ann-city');
    annInp.style.borderColor = '#dc2626'; annInp.focus();
    annInp.addEventListener('input', function(){ annInp.style.borderColor = ''; err.style.display = 'none'; }, { once: true });
    return;
  }
  var btn = document.getElementById('ann-btn');
  var prog = document.getElementById('ann-prog-wrap');
  var err  = document.getElementById('ann-err-box');
  var res  = document.getElementById('annual-result');
  btn.disabled = true; err.style.display = 'none'; res.style.display = 'none'; prog.style.display = 'block';
  setAnnP(0, 'Localisation‚Ä¶');

  var locP = annSelectedLoc ? Promise.resolve(annSelectedLoc) : geocode(city);
  locP.then(function(loc) {
    setAnnP(10, 'R√©cup√©ration des donn√©es + ECMWF‚Ä¶');
    var archiveP = fetchAnnualArchive(loc);
    var seasP = fetchAnnualSeasonal(loc.lat, loc.lon);
    return Promise.all([archiveP, seasP]).then(function(results) {
      var monthly = results[0], seasonal = results[1] || {};
      // Blend seasonal correction into relevant months
      var now = new Date();
      var nowMo = now.getMonth();
      for (var s = 0; s < 7; s++) {
        var mi = (nowMo + s) % 12;
        if (!seasonal[mi] || monthly[mi].avgTemp == null) continue;
        var seas = seasonal[mi];
        var clim = monthly[mi];
        // Temperature: blend 60% clim + 40% seasonal forecast
        var delta = seas.tMean - clim.avgTemp;
        clim.avgTemp    = Math.round((clim.avgTemp + delta * 0.4) * 10) / 10;
        clim.avgTmax    = clim.avgTmax != null ? Math.round((clim.avgTmax + delta * 0.4) * 10) / 10 : null;
        clim.avgTmin    = clim.avgTmin != null ? Math.round((clim.avgTmin + delta * 0.4) * 10) / 10 : null;
        // Rain: blend 60% clim + 40% seasonal
        if (seas.rainProb != null) {
          clim.rainPct = Math.min(100, Math.max(0, Math.round(clim.rainPct * 0.6 + seas.rainProb * 0.4)));
        }
        clim.hasSeasonal = true;
      }
      setAnnP(100, 'Termin√©');
      renderAnnual(loc, monthly);
      prog.style.display = 'none';
      btn.disabled = false;
    });
  }).catch(function(e) {
    err.textContent = 'Erreur : ' + e.message;
    err.style.display = 'block';
    prog.style.display = 'none';
    btn.disabled = false;
  });
}

function setAnnP(p, lbl) {
  document.getElementById('ann-prog-bar').style.width = p + '%';
  document.getElementById('ann-prog-pct').textContent = p + '%';
  if (lbl) document.getElementById('ann-prog-lbl').textContent = lbl;
}

function fetchAnnualArchive(loc) {
  var now = new Date();
  var endYr = now.getFullYear() - 1;
  var startYr = endYr - 2; // 3 years
  var startDate = startYr + '-01-01';
  var endDate   = endYr   + '-12-31';
  var url = 'https://archive-api.open-meteo.com/v1/archive?latitude=' + loc.lat + '&longitude=' + loc.lon +
    '&start_date=' + startDate + '&end_date=' + endDate +
    '&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,shortwave_radiation_sum&timezone=auto';
  return fetch(url).then(function(r) {
    if (!r.ok) throw new Error('Archive indisponible');
    return r.json();
  }).then(function(data) {
    setAnnP(70, 'Agr√©gation mensuelle‚Ä¶');
    return aggregateByMonth(data);
  });
}

function fetchAnnualSeasonal(lat, lon) {
  var now = new Date();
  var start = now.toISOString().split('T')[0];
  var end = new Date(now.getTime() + 210 * 86400000).toISOString().split('T')[0];
  var url = 'https://seasonal-api.open-meteo.com/v1/seasonal?latitude=' + lat + '&longitude=' + lon +
    '&daily=temperature_2m_mean,precipitation_sum&start_date=' + start + '&end_date=' + end;
  return fetch(url).then(function(r) { if (!r.ok) return null; return r.json(); })
    .then(function(data) {
      if (!data || !data.daily || !data.daily.time) return {};
      var times = data.daily.time;
      var ks = Object.keys(data.daily);
      // Buckets by calendar month (0-11)
      var buckets = {};
      for (var i = 0; i < times.length; i++) {
        var mo = parseInt(times[i].split('-')[1], 10) - 1;
        if (!buckets[mo]) buckets[mo] = { temps: [], precips: [] };
        // Collect all member values for this day
        for (var k = 0; k < ks.length; k++) {
          var key = ks[k];
          var val = data.daily[key][i];
          if (val == null) continue;
          if (key.indexOf('temperature_2m_mean') === 0) buckets[mo].temps.push(val);
          if (key.indexOf('precipitation_sum') === 0) buckets[mo].precips.push(val);
        }
      }
      // Aggregate each month
      var result = {};
      var moKeys = Object.keys(buckets);
      for (var m = 0; m < moKeys.length; m++) {
        var mk = parseInt(moKeys[m], 10);
        var b = buckets[mk];
        if (!b.temps.length) continue;
        var tSum = 0; for (var t = 0; t < b.temps.length; t++) tSum += b.temps[t];
        var wet = 0; for (var p = 0; p < b.precips.length; p++) if (b.precips[p] > 0.5) wet++;
        result[mk] = {
          tMean: tSum / b.temps.length,
          rainProb: b.precips.length ? Math.round(wet / b.precips.length * 100) : null
        };
      }
      return result;
    }).catch(function() { return {}; });
}

function aggregateByMonth(data) {
  // buckets[0..11] for Jan..Dec
  var buckets = [];
  for (var m = 0; m < 12; m++) buckets.push({ tmax: [], tmin: [], precip: [], rad: [] });

  var times = data.daily.time;
  var tmax  = data.daily.temperature_2m_max;
  var tmin  = data.daily.temperature_2m_min;
  var prec  = data.daily.precipitation_sum;
  var rad   = data.daily.shortwave_radiation_sum || [];

  for (var i = 0; i < times.length; i++) {
    var mo = parseInt(times[i].split('-')[1], 10) - 1;
    if (tmax[i] != null) buckets[mo].tmax.push(tmax[i]);
    if (tmin[i] != null) buckets[mo].tmin.push(tmin[i]);
    if (prec[i] != null) buckets[mo].precip.push(prec[i]);
    if (rad[i]  != null) buckets[mo].rad.push(rad[i]);
  }

  return buckets.map(function(b, idx) {
    var avgTmax = b.tmax.length ? b.tmax.reduce(function(a,v){return a+v;},0)/b.tmax.length : null;
    var avgTmin = b.tmin.length ? b.tmin.reduce(function(a,v){return a+v;},0)/b.tmin.length : null;
    var avgTemp = (avgTmax != null && avgTmin != null) ? (avgTmax + avgTmin) / 2 : null;
    var rainDays = b.precip.filter(function(v){return v>1;}).length;
    var rainPct  = b.precip.length ? Math.round(rainDays / b.precip.length * 100) : 0;
    var avgRad   = b.rad.length ? b.rad.reduce(function(a,v){return a+v;},0)/b.rad.length : 0;
    // Approx daily sunshine hours from MJ/m¬≤ (1 MJ/m¬≤ ‚âà 0.28 kWh; peak ~1000W ‚Üí rough sunshine hrs)
    var sunHrs   = Math.min(14, Math.round(avgRad / 3.6));
    var avgPrecipMm = b.precip.length ? Math.round(b.precip.reduce(function(a,v){return a+v;},0)/b.precip.length * 10) / 10 : 0;
    return { month: idx, avgTmax: avgTmax, avgTmin: avgTmin, avgTemp: avgTemp, rainPct: rainPct, sunHrs: sunHrs, avgRad: avgRad, avgPrecipMm: avgPrecipMm };
  });
}

function monthScoreForUC(d, uc) {
  var cfg = UC_CONFIG[uc] || UC_CONFIG.general;
  var w = cfg.weights;
  // Reuse scoring functions from date-precise score
  var sRain = scoreRainSmart(d.rainPct, d.avgPrecipMm, d.avgTemp);
  var sTemp = scoreTemp(d.avgTemp, cfg.tempMin, cfg.tempMax);
  var sWind = 85; // monthly data has no wind ‚Äî assume neutral
  var sSun  = scoreSun(d.avgRad);
  return Math.round(sRain * w.rain/100 + sTemp * w.temp/100 + sWind * w.wind/100 + sSun * w.sun/100);
}
function monthScore(d) {
  return monthScoreForUC(d, currentUseCase !== 'general' ? currentUseCase : 'general');
}

function monthColor(d) {
  var t = d.avgTemp;
  if (t == null) return '#a0aec0';
  if (t >= 25)  return '#f59e0b';
  if (t >= 18)  return '#84cc16';
  if (t >= 10)  return '#22d3ee';
  if (t >= 2)   return '#818cf8';
  return '#93c5fd';
}

function monthIconFromData(d) {
  var mm  = d.avgPrecipMm || 0;
  var sun = d.sunHrs || 0;
  var pct = d.rainPct || 0;

  // Snow
  var snowTemp = d.avgTmin != null ? d.avgTmin : d.avgTemp;
  if (snowTemp != null && snowTemp <= 2 && pct > 15) return IC.snow;

  // Pluie effective : m√™me correction que scoreRainSmart
  var effPct = pct;
  if (mm < 3) {
    effPct = pct * (0.40 + (mm / 3) * 0.30);
  } else if (mm < 6) {
    effPct = pct * (0.70 + ((mm - 3) / 3) * 0.30);
  }

  // ‚îÄ‚îÄ Soleil dominant ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (effPct <= 25 && sun >= 6) return IC.sun;
  if (effPct <= 35 && sun >= 8) return IC.sun;

  // ‚îÄ‚îÄ Averses avec soleil ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (effPct <= 55 && sun >= 7) return IC.shower;
  if (effPct <= 45 && sun >= 5) return IC.shower;

  // ‚îÄ‚îÄ Partiellement nuageux ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (effPct <= 45 && sun >= 3) return IC.partcloud;
  if (effPct <= 35) return IC.partcloud;

  // ‚îÄ‚îÄ Pluie ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (effPct <= 65 && sun >= 3) return IC.lightrain;
  if (effPct <= 65) return IC.rain;
  if (effPct <= 80) return IC.rain;
  return IC.heavyrain;
}

var MONTHS_FR = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
var MONTHS_SHORT = ['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];

function renderAnnual(loc, monthly) {
  _lastMonthly = monthly; _lastAnnLoc = loc;
  document.getElementById('ann-city-name').textContent = loc.name + (loc.country ? ' ‚Äî ' + loc.country : '');
  var grid = document.getElementById('months-grid'); grid.innerHTML = '';

  var uc = currentUseCase !== 'general' ? currentUseCase : null;
  var ucNames = {mariage:'mariage',voyage:'voyage',festival:'festival',sport:'outdoor',travaux:'travaux'};

  // Update subtitle
  var subEl = document.getElementById('annual-subtitle');
  var ucSubEl = document.getElementById('annual-subtitle-uc');
  if (uc && ucSubEl) {
    subEl.style.display = 'none';
    var ucLabels = {mariage:'Meilleurs mois pour votre mariage',voyage:'Meilleurs mois pour voyager',festival:'Meilleurs mois pour votre festival',sport:'Meilleurs mois pour votre sortie outdoor',travaux:'Meilleurs mois pour vos travaux'};
    ucSubEl.textContent = ucLabels[uc] || 'Score optimis√© pour : ' + (ucNames[uc]||uc);
    ucSubEl.style.display = 'block';
  } else {
    if (subEl) subEl.style.display = 'block';
    if (ucSubEl) ucSubEl.style.display = 'none';
  }

  // Compute scores for all 12 months
  var scores = [];
  for (var m = 0; m < 12; m++) scores.push({ idx: m, score: monthScoreForUC(monthly[m], uc || 'general') });
  var sorted = scores.slice().sort(function(a,b){ return b.score - a.score; });
  var topIdxs   = sorted[0].score >= 55 ? (sorted[1].score >= 55 ? [sorted[0].idx, sorted[1].idx] : [sorted[0].idx]) : [];
  var worstIdxs = sorted[11].score < 50 ? (sorted[10].score < 50 ? [sorted[10].idx, sorted[11].idx] : [sorted[11].idx]) : [];

  var now = new Date();
  var startMonth = now.getMonth();

  for (var offset = 0; offset < 12; offset++) {
    var idx = (startMonth + offset) % 12;
    var d = monthly[idx];
    var score = scores[idx].score;
    var color = monthColor(d);
    var delay = offset * 40;
    var isRec   = topIdxs.indexOf(idx) >= 0;
    var isAvoid = worstIdxs.indexOf(idx) >= 0;

    var card = document.createElement('div');
    card.className = 'month-card' + (isRec ? ' is-rec' : '') + (isAvoid ? ' is-avoid' : '');
    card.style.setProperty('--month-color', isRec ? '#1a7a4a' : (isAvoid ? '#ef4444' : color));
    card.style.animationDelay = delay + 'ms';

    var scoreNum = '<div class="month-score score-num-uc" style="background:' + getScoreColor(score) + ';color:white;font-size:9px;border-radius:10px;padding:2px 6px;position:absolute;top:10px;right:8px;font-weight:700;opacity:.85">' + score + '</div>';
    var seasBadge = d.hasSeasonal ? '<div class="month-seas-badge">Tendance saison</div>' : '<div class="month-seas-badge" style="visibility:hidden">¬∑</div>';
    var isBest = uc && idx === sorted[0].idx && sorted[0].score >= 60;
    var badgeHtml = isBest ? '<div class="month-best-badge">üî• Meilleur mois</div>' : (isRec ? '<div class="month-badge rec">Recommand√©</div>' : (isAvoid ? '<div class="month-badge avoid">Moins favorable</div>' : ''));

    var tmaxStr = d.avgTmax != null ? Math.round(d.avgTmax) + '¬∞' : '‚Äì';
    var tminStr = d.avgTmin != null ? Math.round(d.avgTmin) + '¬∞' : '‚Äì';
    var tempStr = d.avgTemp != null ? Math.round(d.avgTemp) + '¬∞' : '‚Äì';

    card.innerHTML =
      '<div class="month-name">' + MONTHS_FR[idx] + '</div>' +
      '<div class="month-icon">' + monthIconFromData(d) + '</div>' +
      '<div class="month-temp">' + tminStr + ' / ' + tmaxStr + '</div>' +
      '<div class="month-range">moy. ' + tempStr + '</div>' +
      '<div class="month-stats">' +
        '<span class="month-stat">üíß ' + d.rainPct + '% <span style="font-weight:400;color:var(--slate3);font-size:10px">(' + d.avgPrecipMm + ' mm/j)</span></span>' +
        '<span class="month-stat">‚òÄ ' + d.sunHrs + 'h</span>' +
      '</div>' +
      '<div class="month-bar"><div class="month-bar-fill" style="width:' + d.rainPct + '%"></div></div>' +
      scoreNum + badgeHtml + seasBadge;

    grid.appendChild(card);
  }
  // ‚îÄ‚îÄ L√©gende grille ‚îÄ‚îÄ
  var legendEl = document.getElementById('annual-legend');
  if (!legendEl) {
    legendEl = document.createElement('div');
    legendEl.id = 'annual-legend';
    legendEl.style.cssText = 'display:flex;gap:16px;flex-wrap:wrap;font-size:11px;color:var(--slate3);margin-top:10px;align-items:center;padding:0 2px';
    legendEl.innerHTML = '<span><span style="display:inline-block;width:12px;height:3px;background:#1a7a4a;border-radius:2px;margin-right:5px;vertical-align:middle"></span>Recommand√©</span>' +
      '<span><span style="display:inline-block;width:12px;height:3px;background:#ef4444;border-radius:2px;margin-right:5px;vertical-align:middle"></span>Moins favorable</span>' +
      '<span style="margin-left:auto;font-style:italic;font-size:10px">Couleur barre = temp√©rature moyenne du mois</span>';
    grid.parentNode.insertBefore(legendEl, grid.nextSibling);
  }


  document.getElementById('ann-note').innerHTML = '<strong>Profil climatique</strong> ¬∑ moyenne 3 ans (archive Open-Meteo) ¬∑ les mois marqu√©s <span style="background:#dbeafe;color:#1e40af;font-size:10px;font-weight:700;padding:1px 5px;border-radius:3px">Tendance saison</span> int√®grent une correction par le mod√®le saisonnier ECMWF. Valeurs indicatives.';

  // ‚îÄ‚îÄ R√©sum√© narratif ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  var narEl = document.getElementById('ann-narrative');
  if (narEl) {
    var MNAMES = ['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];
    // Trouver les 2 meilleurs et 2 pires mois
    var sorted2 = scores.slice().sort(function(a,b){return b.score-a.score;});
    var best1 = sorted2[0], best2 = sorted2[1];
    var worst1 = sorted2[11], worst2 = sorted2[10];
    
    // Construire fen√™tre optimale (mois cons√©cutifs avec score >= 60)
    var goodMonths = scores.filter(function(s){return s.score >= 60;}).map(function(s){return s.idx;});
    
    var ucLabel = {'mariage':'c√©r√©monie en ext√©rieur','voyage':'voyager','festival':'votre festival','sport':'activit√©s outdoor','travaux':'vos travaux','general':'partir'}[uc||'general'] || 'partir';
    
    var bestName1 = MNAMES[best1.idx];
    var bestName2 = MNAMES[best2.idx];
    var worstName = MNAMES[worst1.idx];
    
    var emoji = best1.score >= 75 ? 'üåü' : best1.score >= 60 ? '‚úÖ' : '‚ö†Ô∏è';
    
    var narrative = emoji + ' <strong>Meilleur mois : ' + bestName1.charAt(0).toUpperCase() + bestName1.slice(1);
    if (best2.score >= 55) narrative += ' et ' + bestName2;
    narrative += '</strong>';
    
    if (goodMonths.length >= 2) {
      narrative += ' ¬∑ Fen√™tre favorable : <strong>' + goodMonths.length + ' mois</strong>';
    }
    
    if (uc && worst1.score < 50) {
      narrative += ' ¬∑ √âviter : <span style="color:#ef4444;font-weight:700">' + worstName + '</span>';
      if (worst2.score < 50) narrative += ' et ' + MNAMES[worst2.idx];
    }
    
    // Temp√©rature indicative du meilleur mois
    var bestData = monthly[best1.idx];
    if (bestData && bestData.avgTmax) {
      narrative += ' ¬∑ ' + Math.round(bestData.avgTmax) + '¬∞C max ¬∑ ' + bestData.rainPct + '% pluie';
    }
    
    narEl.innerHTML = narrative;
    narEl.style.display = 'block';
  }
  // ‚îÄ‚îÄ fin r√©sum√© narratif ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  document.getElementById('annual-result').style.display = 'block';
}


document.getElementById('btn-go').onclick=function(){run();};
// Annual autocomplete listeners
function clearCity(){
  var el=document.getElementById('inp-city');
  el.value=''; selectedLoc=null;
  document.getElementById('inp-city-clear').classList.remove('visible');
  hideAC(); el.focus();
}
function clearAnnCity(){
  var el=document.getElementById('ann-city');
  el.value=''; annSelectedLoc=null;
  document.getElementById('ann-city-clear').classList.remove('visible');
  hideAnnAC(); el.focus();
}
document.getElementById('ann-city').oninput=function(){
  annSelectedLoc=null;var q=this.value.trim();clearTimeout(annAcTimer);
  document.getElementById('ann-city-clear').classList.toggle('visible',q.length>0);
  if(q.length<2){hideAnnAC();return;}
  annAcTimer=setTimeout(function(){fetch('https://geocoding-api.open-meteo.com/v1/search?name='+encodeURIComponent(q)+'&count=6&language=fr').then(function(r){return r.json();}).then(function(d){showAnnAC(d.results||[]);}).catch(function(){hideAnnAC();});},280);
};
document.getElementById('ann-city').onblur=function(){setTimeout(hideAnnAC,180);};
document.getElementById('ann-city').onkeydown=function(e){
  var list=document.getElementById('ann-ac-list'),items=list.querySelectorAll('.ac-item'),n=items.length;
  if(e.key==='ArrowDown'){e.preventDefault();annAcIdx=annAcIdx<n-1?annAcIdx+1:n-1;for(var i=0;i<n;i++)items[i].className='ac-item'+(i===annAcIdx?' sel':'');}
  else if(e.key==='ArrowUp'){e.preventDefault();annAcIdx=annAcIdx>0?annAcIdx-1:0;for(var i=0;i<n;i++)items[i].className='ac-item'+(i===annAcIdx?' sel':'');}
  else if(e.key==='Enter'){if(annAcIdx>=0&&list.style.display!=='none'){selectAnnAC(annAcIdx);}else{hideAnnAC();runAnnual();}}
  else if(e.key==='Escape'){hideAnnAC();}
};
document.getElementById('annual-wrap').style.display='none';
// Pre-select "Juste la m√©t√©o" by default
quickFill('general');
// Show hint if user tries to interact before selecting use case
document.getElementById('date-form').addEventListener('click', function() {
  if (this.classList.contains('uc-required')) {
    var hint = document.getElementById('uc-hint');
    if (hint) { hint.classList.add('visible'); }
    // Highlight pills briefly
    var pills = document.querySelectorAll('.uc-pill');
    for (var i=0; i<pills.length; i++) {
      pills[i].style.borderColor = 'var(--gold)';
      (function(p){ setTimeout(function(){ p.style.borderColor=''; }, 800); })(pills[i]);
    }
  }
}, true);
document.getElementById('annual-wrap').addEventListener('click', function() {
  if (this.classList.contains('uc-required-ann')) {
    var hint = document.getElementById('uc-hint-ann');
    if (hint) { hint.classList.add('visible'); }
    var pills = document.querySelectorAll('.uc-pill');
    for (var i=0; i<pills.length; i++) {
      pills[i].style.borderColor = 'var(--gold)';
      (function(p){ setTimeout(function(){ p.style.borderColor=''; }, 800); })(pills[i]);
    }
  }
}, true);
document.addEventListener('DOMContentLoaded', function() {
  flatpickr(document.getElementById('inp-date'), {
    dateFormat: 'd/m/Y',
    locale: 'fr',
    minDate: 'today',
    maxDate: new Date(new Date().setFullYear(new Date().getFullYear()+1)),
    disableMobile: true,
    onChange: function(selectedDates, dateStr) {
      var el = document.getElementById('inp-date');
      el.classList.toggle('has-val', selectedDates.length > 0);
      if (selectedDates.length > 0) {
        var d = selectedDates[0];
        el._isoValue = d.getFullYear()+'-'+(d.getMonth()<9?'0':'')+(d.getMonth()+1)+'-'+(d.getDate()<10?'0':'')+d.getDate();
      } else {
        el._isoValue = '';
      }
    }
  });
});
document.getElementById('inp-city').oninput=function(){
  selectedLoc=null;
  // Don't reset use case when typing city ‚Äî user keeps their project selection
  var q=this.value.trim();clearTimeout(acTimer);
  document.getElementById('inp-city-clear').classList.toggle('visible',q.length>0);
  if(q.length<2){hideAC();return;}
  acTimer=setTimeout(function(){fetchAC(q);},280);
};
document.getElementById('inp-city').onblur=function(){setTimeout(hideAC,180);};
document.getElementById('inp-city').onkeydown=function(e){
  var list=document.getElementById('ac-list'), items=list.querySelectorAll('.ac-item'), n=items.length;
  if(e.key==='ArrowDown'){e.preventDefault();acIdx=acIdx<n-1?acIdx+1:n-1;for(var i=0;i<n;i++)items[i].className='ac-item'+(i===acIdx?' sel':'');}
  else if(e.key==='ArrowUp'){e.preventDefault();acIdx=acIdx>0?acIdx-1:0;for(var i=0;i<n;i++)items[i].className='ac-item'+(i===acIdx?' sel':'');}
  else if(e.key==='Enter'){if(acIdx>=0&&list.style.display!=='none'){selectAC(acIdx);}else{hideAC();run();}}
  else if(e.key==='Escape'){hideAC();}
};
document.getElementById('inp-date').onkeydown=function(e){if(e.key==='Enter')run();};
var tom=new Date(), maxD=new Date();tom.setHours(0,0,0,0);maxD.setFullYear(maxD.getFullYear()+2);
// min/max g√©r√©s par flatpickr

// ‚îÄ‚îÄ URL PARAMS : pr√©-remplir ville + lancer vue annuelle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  function getParam(name) {
    var search = window.location.search.substring(1);
    var parts = search.split('&');
    for (var i = 0; i < parts.length; i++) {
      var kv = parts[i].split('=');
      if (decodeURIComponent(kv[0]) === name) return decodeURIComponent(kv[1] || '');
    }
    return null;
  }
  var city = getParam('city');
  var lat  = getParam('lat');
  var lon  = getParam('lon');
  var uc   = getParam('uc');
  if (city && lat && lon) {
    switchMode('annual');
    var el = document.getElementById('ann-city');
    el.value = city;
    document.getElementById('ann-city-clear').classList.add('visible');
    annSelectedLoc = { lat: parseFloat(lat), lon: parseFloat(lon), name: city, region: '', country: '' };
    if (uc) { currentUseCase = uc; quickFill(uc); }
    setTimeout(function() { runAnnual(); }, 100);
  }
})();
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(reg) {
      console.log('SW enregistr√©:', reg.scope);
    }).catch(function(err) {
      console.log('SW erreur:', err);
    });
  });
}
</script>




<script>
// Auto-resize iframe parent
function notifyParentHeight(){
  var h = document.documentElement.scrollHeight;
  if(window.parent !== window){
    window.parent.postMessage({type:'bdw-resize',height:h},'*');
  }
}
if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded', function(){setTimeout(notifyParentHeight,300);});
} else { setTimeout(notifyParentHeight,300); }
new MutationObserver(function(){setTimeout(notifyParentHeight,100);}).observe(document.body,{childList:true,subtree:true,attributes:true});
window.addEventListener('resize',notifyParentHeight);
</script>
</body>
</html>
